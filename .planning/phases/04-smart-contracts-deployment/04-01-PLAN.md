---
phase: 04-smart-contracts-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - contracts_age_verifier/Scarb.toml
  - contracts_age_verifier/src/lib.cairo
  - contracts_age_verifier/src/honk_verifier.cairo
  - contracts_age_verifier/src/honk_verifier_circuits.cairo
  - contracts_age_verifier/src/honk_verifier_constants.cairo
  - contracts_membership_verifier/Scarb.toml
  - contracts_membership_verifier/src/lib.cairo
  - contracts_membership_verifier/src/honk_verifier.cairo
  - contracts_membership_verifier/src/honk_verifier_circuits.cairo
  - contracts_membership_verifier/src/honk_verifier_constants.cairo
  - .secrets
  - .gitignore
autonomous: false
user_setup:
  - service: starknet-sepolia
    why: "Contract deployment requires funded Sepolia account"
    env_vars:
      - name: STARKNET_PRIVATE_KEY
        source: "Your Starknet wallet private key (ArgentX or Braavos export)"
      - name: STARKNET_ACCOUNT_ADDRESS
        source: "Your Starknet Sepolia account address"
      - name: STARKNET_RPC
        source: "Starknet Sepolia RPC URL (default: https://rpc.starknet-testnet.lava.build:443)"
    dashboard_config:
      - task: "Fund Sepolia account with STRK"
        location: "https://starknet-faucet.vercel.app/ or Starknet Sepolia faucet"

must_haves:
  truths:
    - "Garaga-generated age_verify verifier contract is deployed on Starknet Sepolia"
    - "Garaga-generated membership_proof verifier contract is deployed on Starknet Sepolia"
    - "Both verifiers successfully verify valid proofs submitted via garaga verify-onchain CLI"
    - "Generated verifier constants show correct public_inputs_size (9 for age, 16 for membership)"
  artifacts:
    - path: "contracts_age_verifier/src/honk_verifier_constants.cairo"
      provides: "Age verify VK constants with PUB_9"
      contains: "public_inputs_size"
    - path: "contracts_membership_verifier/src/honk_verifier_constants.cairo"
      provides: "Membership proof VK constants with PUB_16"
      contains: "public_inputs_size"
    - path: ".secrets"
      provides: "Deployment credentials for Sepolia"
      contains: "STARKNET_PRIVATE_KEY"
  key_links:
    - from: "circuits/target/age_verify_vk/vk"
      to: "contracts_age_verifier/src/honk_verifier_constants.cairo"
      via: "garaga gen --vk"
      pattern: "garaga gen.*age_verify_vk"
    - from: "circuits/target/membership_proof_vk/vk"
      to: "contracts_membership_verifier/src/honk_verifier_constants.cairo"
      via: "garaga gen --vk"
      pattern: "garaga gen.*membership_proof_vk"
---

<objective>
Generate Garaga verifier contracts for both the age_verify and membership_proof circuits, compile them, declare and deploy them on Starknet Sepolia, and validate end-to-end with garaga verify-onchain.

Purpose: The deployed verifier contracts are the on-chain foundation that the StarkShieldRegistry (Plan 02) will route to. Without deployed verifiers, no proof can be verified on-chain.

Output: Two deployed verifier contracts on Sepolia with known addresses, verified working via garaga verify-onchain. Deployed addresses recorded for Plan 02.
</objective>

<execution_context>
@/Users/laitsky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laitsky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-smart-contracts-deployment/04-RESEARCH.md
@.planning/phases/01-toolchain-validation-circuit-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate, compile, and deploy both Garaga verifier contracts to Sepolia</name>
  <files>
    contracts_age_verifier/Scarb.toml
    contracts_age_verifier/src/lib.cairo
    contracts_age_verifier/src/honk_verifier.cairo
    contracts_age_verifier/src/honk_verifier_circuits.cairo
    contracts_age_verifier/src/honk_verifier_constants.cairo
    contracts_membership_verifier/Scarb.toml
    contracts_membership_verifier/src/lib.cairo
    contracts_membership_verifier/src/honk_verifier.cairo
    contracts_membership_verifier/src/honk_verifier_circuits.cairo
    contracts_membership_verifier/src/honk_verifier_constants.cairo
    .secrets
    .gitignore
  </files>
  <action>
    Generate two separate Garaga verifier projects -- one per circuit VK. Each `garaga gen` invocation produces a complete Scarb project. Then compile, declare, and deploy both to Starknet Sepolia.

    **Step 1: Verify VK files exist**
    Confirm that `circuits/target/age_verify_vk/vk` and `circuits/target/membership_proof_vk/vk` exist from Phases 2-3. If missing, rebuild: `cd circuits && nargo build` then `bb write_vk -s ultra_honk --oracle_hash keccak -b target/age_verify.json -o target/age_verify_vk` (and same for membership_proof).

    **Step 2: Generate age_verify verifier**
    ```bash
    source .venv/bin/activate
    garaga gen --system ultra_keccak_zk_honk \
      --vk circuits/target/age_verify_vk/vk \
      --project-name contracts_age_verifier
    ```
    After generation, verify the constants file contains the correct public_inputs_size. For age_verify this should indicate 9 public inputs.

    **Step 3: Generate membership_proof verifier**
    ```bash
    garaga gen --system ultra_keccak_zk_honk \
      --vk circuits/target/membership_proof_vk/vk \
      --project-name contracts_membership_verifier
    ```
    After generation, verify constants file shows 16 public inputs for membership_proof.

    **Step 4: Copy .tool-versions to new projects**
    Each generated project needs `scarb 2.14.0` and `starknet-foundry 0.53.0` in `.tool-versions`. Copy from `contracts/.tool-versions` to both new projects.

    **Step 5: Compile both verifier contracts**
    ```bash
    cd contracts_age_verifier && scarb build && cd ..
    cd contracts_membership_verifier && scarb build && cd ..
    ```
    Both must compile successfully (exit 0, Sierra artifacts generated).

    **Step 6: Create .secrets file**
    Create `.secrets` in project root with:
    ```
    STARKNET_RPC="https://rpc.starknet-testnet.lava.build:443"
    STARKNET_PRIVATE_KEY=0x<user_provided>
    STARKNET_ACCOUNT_ADDRESS=0x<user_provided>
    ```
    Add `.secrets` to `.gitignore` if not already present. Also add `contracts_age_verifier/target/` and `contracts_membership_verifier/target/` to `.gitignore`.

    IMPORTANT: If `.secrets` does not exist and cannot be created (user has not provided credentials), create a PLACEHOLDER `.secrets` file and note the checkpoint below will handle credential collection.

    **Step 7: Declare and deploy age_verify verifier**
    ```bash
    source .venv/bin/activate
    garaga declare --project-path contracts_age_verifier --env-file .secrets --network sepolia
    # Capture the class hash from output
    garaga deploy --class-hash <AGE_CLASS_HASH> --env-file .secrets --network sepolia
    # Capture the deployed contract address
    ```

    **Step 8: Declare and deploy membership_proof verifier**
    ```bash
    garaga declare --project-path contracts_membership_verifier --env-file .secrets --network sepolia
    garaga deploy --class-hash <MEMBERSHIP_CLASS_HASH> --env-file .secrets --network sepolia
    ```

    **Step 9: Record deployed addresses**
    Create a `deployments.json` file in project root recording:
    ```json
    {
      "network": "sepolia",
      "age_verifier": {
        "class_hash": "0x...",
        "contract_address": "0x..."
      },
      "membership_verifier": {
        "class_hash": "0x...",
        "contract_address": "0x..."
      }
    }
    ```

    **Step 10: Validate with garaga verify-onchain**
    ```bash
    # Validate age verifier
    garaga verify-onchain \
      --system ultra_keccak_zk_honk \
      --contract-address <AGE_VERIFIER_ADDRESS> \
      --proof circuits/target/age_verify_proof/proof \
      --vk circuits/target/age_verify_vk/vk \
      --env-file .secrets \
      --network sepolia

    # Validate membership verifier
    garaga verify-onchain \
      --system ultra_keccak_zk_honk \
      --contract-address <MEMBERSHIP_VERIFIER_ADDRESS> \
      --proof circuits/target/membership_proof_proof/proof \
      --vk circuits/target/membership_proof_vk/vk \
      --env-file .secrets \
      --network sepolia
    ```

    Both commands must succeed. Record the gas costs from the transaction receipts -- this is the first gas benchmark data (relevant to CONT-07 success criteria).

    **Pitfall avoidance:**
    - Do NOT use the existing `contracts/` directory verifier -- it was generated from the trivial circuit VK (PUB_17), not the real circuits
    - If `garaga declare` fails with "insufficient balance", the user needs to fund their Sepolia account via faucet
    - If `scarb build` hangs, confirm scarb version is 2.14.0 (NOT 2.15.x)
    - The proof files in `circuits/target/` are from Phases 2-3 and should already exist. If they need regeneration, run the full bb pipeline for each circuit
  </action>
  <verify>
    1. `ls contracts_age_verifier/src/honk_verifier_constants.cairo` exists
    2. `ls contracts_membership_verifier/src/honk_verifier_constants.cairo` exists
    3. `scarb build` exits 0 in both verifier directories
    4. `deployments.json` exists with both verifier addresses
    5. `garaga verify-onchain` succeeds for both circuits (exit 0)
  </verify>
  <done>
    Both Garaga-generated verifier contracts are deployed on Starknet Sepolia. garaga verify-onchain confirms both can verify valid proofs. Deployed addresses are recorded in deployments.json. Gas costs from verify-onchain transactions are noted.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Sepolia deployment and gas costs</name>
  <what-built>
    Two Garaga-generated HonkVerifier contracts deployed on Starknet Sepolia:
    1. Age verify verifier (9 public inputs)
    2. Membership proof verifier (16 public inputs)
    Both validated via garaga verify-onchain.
  </what-built>
  <how-to-verify>
    1. Check `deployments.json` in project root for both contract addresses
    2. Visit Starkscan Sepolia (https://sepolia.starkscan.co/) and search for both contract addresses -- confirm they exist as deployed contracts
    3. Review the gas cost from the verify-onchain transaction receipts. If either exceeds ~450K gas for JUST the verifier call (before registry overhead), the 500K total target (CONT-07) may be at risk -- note this for planning
    4. Confirm `.secrets` is in `.gitignore` and NOT committed to git
  </how-to-verify>
  <resume-signal>Type "approved" with any gas cost notes, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Both verifier contracts visible on Starkscan Sepolia
- garaga verify-onchain exits 0 for both age_verify and membership_proof
- deployments.json contains valid Sepolia addresses for both verifiers
- .secrets file is gitignored
- Verifier constants show correct public_inputs_size (9 and 16)
</verification>

<success_criteria>
- Two HonkVerifier contracts deployed on Starknet Sepolia (CONT-01 partial)
- Both contracts successfully verify valid proofs via CLI (CONT-01 complete)
- Gas cost baseline established for verifier-only calls (CONT-07 data point)
- Deployed addresses available for StarkShieldRegistry integration (Plan 02 unblocked)
</success_criteria>

<output>
After completion, create `.planning/phases/04-smart-contracts-deployment/04-01-SUMMARY.md`
</output>
