---
phase: 02-age-verification-circuit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - circuits/Nargo.toml
  - circuits/crates/age_verify/Nargo.toml
  - circuits/crates/age_verify/src/main.nr
  - circuits/crates/age_verify/Prover.toml
  - scripts/issuer.ts
autonomous: true

must_haves:
  truths:
    - "A signed credential with age >= threshold produces a valid proof via the full bb pipeline (build, execute, write_vk, prove, verify all exit 0)"
    - "An expired credential (current_timestamp >= expires_at) is rejected by the circuit with assertion failure"
    - "A credential with age < threshold is rejected by the circuit with assertion failure"
    - "A credential signed by a wrong keypair is rejected by the circuit with assertion failure"
    - "Two different dapp_context_ids produce two different nullifiers for the same credential"
    - "The same dapp_context_id always produces the same nullifier for the same credential"
    - "No private data (subject_id, attribute_value, secret_salt, etc.) appears in the proof's public_inputs file"
  artifacts:
    - path: "circuits/crates/age_verify/src/main.nr"
      provides: "Age verification circuit with signature check, expiration check, age comparison, nullifier derivation"
      contains: "fn main"
    - path: "circuits/crates/age_verify/Nargo.toml"
      provides: "Binary crate config with shared_lib and poseidon deps"
      contains: "age_verify"
    - path: "circuits/crates/age_verify/Prover.toml"
      provides: "Default witness inputs from demo credential"
      contains: "subject_id"
    - path: "circuits/Nargo.toml"
      provides: "Updated workspace with age_verify member"
      contains: "age_verify"
    - path: "scripts/issuer.ts"
      provides: "Extended issuer with --expired and --young flags for test fixtures"
      contains: "expired"
  key_links:
    - from: "circuits/crates/age_verify/src/main.nr"
      to: "circuits/crates/shared_lib/src/credential.nr"
      via: "use dep::shared_lib::credential::Credential"
      pattern: "shared_lib::credential::Credential"
    - from: "circuits/crates/age_verify/src/main.nr"
      to: "circuits/crates/shared_lib/src/schnorr.nr"
      via: "use dep::shared_lib::schnorr::assert_credential_signature"
      pattern: "assert_credential_signature"
    - from: "circuits/crates/age_verify/src/main.nr"
      to: "circuits/crates/shared_lib/src/nullifier.nr"
      via: "use dep::shared_lib::nullifier::derive_nullifier"
      pattern: "derive_nullifier"
    - from: "circuits/crates/age_verify/Prover.toml"
      to: "scripts/issuer.ts"
      via: "Issuer generates Prover.toml with correct field format"
      pattern: "current_timestamp"
---

<objective>
Build the age_verify Noir circuit that proves age >= threshold with issuer signature verification, expiration enforcement, and per-dApp nullifier derivation. Validate the complete compile-prove-verify pipeline with real credential data.

Purpose: This is the first production circuit in StarkShield. It implements requirements CIRC-01 (age comparison), CIRC-03 (signature verification), CIRC-04 (expiration check), CIRC-05 (per-dApp nullifiers), and CIRC-06 (clean public outputs). Downstream phases (3, 4, 5) depend on the circuit artifacts and proven patterns from this phase.

Output: Compiled age_verify circuit with passing nargo tests, verified bb proof, documented public output ordering, and extended issuer for test fixture generation.
</objective>

<execution_context>
@/Users/laitsky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laitsky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-age-verification-circuit/02-RESEARCH.md
@.planning/phases/01-toolchain-validation-circuit-foundation/01-02-SUMMARY.md

Source files to reference:
@circuits/crates/shared_lib/src/credential.nr
@circuits/crates/shared_lib/src/schnorr.nr
@circuits/crates/shared_lib/src/nullifier.nr
@circuits/crates/shared_lib/src/lib.nr
@circuits/crates/trivial/src/main.nr (pattern reference for how shared_lib is imported and used)
@circuits/crates/trivial/Nargo.toml (pattern reference for binary crate config)
@circuits/crates/trivial/Prover.toml (pattern reference for TOML field formatting)
@circuits/Nargo.toml (workspace root -- must add age_verify member)
@scripts/issuer.ts (extend for test fixture generation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create age_verify circuit crate with Noir tests and test fixtures</name>
  <files>
    circuits/Nargo.toml
    circuits/crates/age_verify/Nargo.toml
    circuits/crates/age_verify/src/main.nr
    circuits/crates/age_verify/Prover.toml
    scripts/issuer.ts
  </files>
  <action>
**1. Create age_verify crate structure:**

Create `circuits/crates/age_verify/Nargo.toml`:
```toml
[package]
name = "age_verify"
type = "bin"
compiler_version = ">=0.36.0"

[dependencies]
poseidon = { tag = "v0.2.3", git = "https://github.com/noir-lang/poseidon" }
shared_lib = { path = "../shared_lib" }
```

**2. Update workspace root** `circuits/Nargo.toml`:
```toml
[workspace]
members = ["crates/shared_lib", "crates/trivial", "crates/age_verify"]
default-member = "crates/age_verify"
```

**3. Create the age_verify circuit** in `circuits/crates/age_verify/src/main.nr`:

The circuit follows the research recommendation: hard-assert all checks (signature, expiration, age >= threshold). Proof existence IS the "passed" signal. The circuit returns computed public outputs via `-> pub`.

```noir
use dep::shared_lib::credential::Credential;
use dep::shared_lib::schnorr::assert_credential_signature;
use dep::shared_lib::nullifier::derive_nullifier;

fn main(
    // Private witness: credential fields
    subject_id: Field,
    issuer_id: Field,
    credential_type: Field,
    attribute_key: Field,
    attribute_value: Field,
    issued_at: Field,
    expires_at: Field,
    secret_salt: Field,
    // Private witness: signature
    signature: [u8; 64],
    // Public inputs: verification parameters
    pub_key_x: pub Field,
    pub_key_y: pub Field,
    current_timestamp: pub Field,
    threshold: pub Field,
    dapp_context_id: pub Field,
) -> pub (Field, Field, Field, Field) {
    // Returns: (nullifier, issuer_pub_key_x, attribute_key, threshold)
    // If this function returns, all checks passed. Proof existence = "passed = true".

    // 1. Construct credential and compute hash
    let credential = Credential {
        subject_id,
        issuer_id,
        credential_type,
        attribute_key,
        attribute_value,
        issued_at,
        expires_at,
        secret_salt,
    };
    let credential_hash = credential.hash();

    // 2. Verify issuer signature (HARD ASSERT -- forged credential = no proof)
    assert_credential_signature(pub_key_x, pub_key_y, signature, credential_hash);

    // 3. Check expiration (HARD ASSERT -- expired credential = no proof)
    // Cast to u64 for safe ordered comparison (prevents modular wrap-around)
    let ts = current_timestamp as u64;
    let exp = expires_at as u64;
    assert(ts < exp, "Credential has expired");

    // 4. Check age threshold (HARD ASSERT -- underage = no proof)
    let age = attribute_value as u64;
    let min_age = threshold as u64;
    assert(age >= min_age, "Age below threshold");

    // 5. Derive per-dApp nullifier
    let nullifier = derive_nullifier(secret_salt, credential_hash, dapp_context_id);

    // 6. Return public outputs
    // Contract reads these to: check issuer is trusted, log verification, store nullifier
    (nullifier, pub_key_x, attribute_key, threshold)
}
```

Add the following Noir tests in the same file (below main). Use hardcoded values from the demo credential generated in Phase 1. The tests exercise all five success criteria from the roadmap.

The test values come from the existing `circuits/crates/trivial/Prover.toml`:
- subject_id: `0x14a0cf45bdb4ee2266b1c7496d9d3305aa60e684b2023c3fea9c10c08617482b`
- attribute_value: `0x19` (25 in decimal, the age)
- expires_at: `0x6b7190fb` (a future timestamp)
- pub_key_x, pub_key_y, signature: from the trivial Prover.toml
- dapp_context_id: `0x2a` (42)
- expected nullifier: `0x1b291cc63a9aa3f46a2597d6618f3358c53e88b0f383ef951f68594abd87982d`

**Tests to write (6 total):**

1. `test_valid_age_verification` -- Call main() with all valid inputs, threshold=18, current_timestamp well before expires_at. Verify it returns without assertion failure and the returned nullifier matches the expected value.

2. `test_expired_credential_rejected` -- Same credential but set current_timestamp to a value >= expires_at. Use `#[test(should_fail_with = "Credential has expired")]`.

3. `test_age_below_threshold_rejected` -- Same credential (age=25) but threshold=30. Use `#[test(should_fail_with = "Age below threshold")]`.

4. `test_wrong_signature_rejected` -- Same credential fields but tamper one signature byte (e.g., flip first byte). Use `#[test(should_fail)]` (Schnorr assertion failure message may vary).

5. `test_different_context_different_nullifier` -- Use shared_lib::nullifier::derive_nullifier directly with two different dapp_context_ids and the same salt/hash. Assert the results differ.

6. `test_same_context_same_nullifier` -- Call derive_nullifier twice with identical inputs. Assert results are equal.

**Important Noir syntax notes for beta.16:**
- All `use` statements MUST be at module top level (not inside functions)
- Boolean operators: use `&` and `|` (not `&&` and `||`)
- Array literal for signature: `[24, 176, 76, ...]` as u8 values (can use decimal integers directly in test code)
- `#[test(should_fail_with = "...")]` matches substring of assertion message

**4. Extend scripts/issuer.ts for test fixture generation:**

Add two new CLI flags to the existing issuer.ts:
- `--expired`: Sets `expires_at` to a past timestamp (current time - 86400 seconds) instead of +1 year
- `--young`: Sets `attribute_value` to 15n (age = 15, below typical 18 threshold) instead of 25

These flags compose with `--type`. Examples:
```
npx tsx issuer.ts                    # age=25, valid expiry
npx tsx issuer.ts --expired          # age=25, expired yesterday
npx tsx issuer.ts --young            # age=15, valid expiry
npx tsx issuer.ts --type membership  # membership, valid
```

Update the `generateProverToml` function to include the new fields needed for age_verify circuit (current_timestamp, threshold) instead of expected_nullifier. The age_verify circuit has different parameters than the trivial circuit:
- Add `current_timestamp` field (set to current time for valid credentials, set to expires_at+1 for expired test)
- Add `threshold` field (default "18")
- Remove `expected_nullifier` (age_verify uses return values, not expected-value assertions)

**5. Generate fresh Prover.toml for age_verify:**

After extending issuer.ts, run `cd /Users/laitsky/Developments/starkshield/scripts && npx tsx issuer.ts` to generate a fresh credential.

Copy the generated prover_age.toml content pattern to create `circuits/crates/age_verify/Prover.toml` with the fields matching the age_verify circuit signature: subject_id, issuer_id, credential_type, attribute_key, attribute_value, issued_at, expires_at, secret_salt, signature, pub_key_x, pub_key_y, current_timestamp, threshold, dapp_context_id.

Alternatively, since the Noir tests use hardcoded values from the Phase 1 demo credential (already cross-validated), you can create the Prover.toml manually using those same values. Set current_timestamp to a value well before expires_at (e.g., issued_at + 1000), and threshold to "18".

**6. Build and test:**
```bash
cd /Users/laitsky/Developments/starkshield/circuits
nargo build --package age_verify    # Must compile without errors
nargo test --package age_verify     # All 6 tests must pass
nargo info --package age_verify     # Record ACIR opcode count (expect ~1,500-2,000)
```
  </action>
  <verify>
Run from workspace root:
```bash
cd /Users/laitsky/Developments/starkshield/circuits
nargo build --package age_verify   # exit 0, produces target/age_verify.json
nargo test --package age_verify    # exit 0, all 6 tests pass
nargo info --package age_verify    # exit 0, reports ACIR opcode count < 5000
```
Verify `circuits/crates/age_verify/src/main.nr` exists and contains `fn main` with 14 parameters + return type.
Verify `circuits/Nargo.toml` workspace members includes "crates/age_verify".
  </verify>
  <done>
The age_verify circuit compiles, all 6 nargo tests pass (valid proof, expired rejection, underage rejection, wrong signature rejection, different context different nullifier, same context same nullifier), and ACIR opcode count is under 5,000.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate full bb prove/verify pipeline and document public output ordering</name>
  <files>
    circuits/crates/age_verify/Prover.toml
  </files>
  <action>
**1. Generate witness:**
```bash
cd /Users/laitsky/Developments/starkshield/circuits
nargo execute --package age_verify
```
Check what files appear in `target/` -- document whether the witness is at `target/age_verify.gz` or another path. If `nargo execute --package age_verify` does not resolve Prover.toml correctly, fall back to `cd crates/age_verify && nargo execute`.

**2. Generate verification key:**
```bash
cd /Users/laitsky/Developments/starkshield/circuits
rm -rf target/age_verify_vk 2>/dev/null
bb write_vk -s ultra_honk --oracle_hash keccak \
  -b target/age_verify.json -o target/age_verify_vk
```
Note: bb write_vk creates a nested directory. The VK file will be at `target/age_verify_vk/vk`. Verify this path exists.

**3. Generate proof:**
```bash
cd /Users/laitsky/Developments/starkshield/circuits
rm -rf target/age_verify_proof 2>/dev/null
bb prove -s ultra_honk --oracle_hash keccak \
  -b target/age_verify.json -w target/age_verify.gz \
  -k target/age_verify_vk/vk -o target/age_verify_proof
```
If the witness file is not at `target/age_verify.gz`, use the actual path discovered in step 1. The proof output will be at `target/age_verify_proof/proof` and public inputs at `target/age_verify_proof/public_inputs`.

**4. Verify proof:**
```bash
cd /Users/laitsky/Developments/starkshield/circuits
bb verify -s ultra_honk --oracle_hash keccak \
  -k target/age_verify_vk/vk \
  -p target/age_verify_proof/proof \
  -i target/age_verify_proof/public_inputs
```
Must output "Proof verified successfully" and exit 0.

**5. Document public output ordering:**

Read the file at `target/age_verify_proof/public_inputs`. This is a critical step for Phase 4 (contract reads public inputs by index) and Phase 5 (SDK proof handling).

The file will contain field elements (hex strings). Document which index corresponds to which value:
- Return values: (nullifier, issuer_pub_key_x, attribute_key, threshold) -- 4 fields
- Public input parameters: (pub_key_x, pub_key_y, current_timestamp, threshold, dapp_context_id) -- 5 fields

Compare the hex values in public_inputs against the known input values from Prover.toml to determine the exact ordering. Record this mapping as a comment in main.nr for future reference:
```noir
// Public output ordering in bb proof format (verified empirically):
// Index 0: nullifier (return value)
// Index 1: issuer_pub_key_x (return value = pub_key_x)
// Index 2: attribute_key (return value)
// Index 3: threshold (return value)
// Index 4: pub_key_x (public input)
// ... (document actual ordering found)
```

**6. Verify no private data leaks:**

Inspect the public_inputs file and confirm that NONE of these values appear:
- subject_id
- attribute_value (the actual age, e.g., 25 = 0x19)
- secret_salt
- issued_at
- expires_at
- signature bytes

The only values in public_inputs should be: nullifier (computed), pub_key_x, pub_key_y, current_timestamp, threshold, dapp_context_id, attribute_key.

**7. Record constraint count:**

The `nargo info --package age_verify` output from Task 1 gives the ACIR opcode count. If not already recorded, run it again. The target is under 5,000 ACIR opcodes. Document the exact count in the main.nr header comment alongside the public output ordering.
  </action>
  <verify>
Run the full pipeline:
```bash
cd /Users/laitsky/Developments/starkshield/circuits
nargo execute --package age_verify && \
bb write_vk -s ultra_honk --oracle_hash keccak -b target/age_verify.json -o target/age_verify_vk && \
bb prove -s ultra_honk --oracle_hash keccak -b target/age_verify.json -w target/age_verify.gz -k target/age_verify_vk/vk -o target/age_verify_proof && \
bb verify -s ultra_honk --oracle_hash keccak -k target/age_verify_vk/vk -p target/age_verify_proof/proof -i target/age_verify_proof/public_inputs
```
All four commands exit 0. The verify command outputs "Proof verified successfully".
The public_inputs file contains only the expected public values (no private credential data).
The main.nr file contains a comment documenting the empirically-verified public output ordering.
  </verify>
  <done>
The full compile-execute-prove-verify pipeline succeeds for the age_verify circuit. The proof is valid. Public output ordering is documented in main.nr. No private data appears in public_inputs. Constraint count is recorded and under 5,000 ACIR opcodes.
  </done>
</task>

</tasks>

<verification>
Phase 2 success criteria check (from ROADMAP.md):

1. **CIRC-01 (age >= threshold)**: Verified by `test_valid_age_verification` (passes) and `test_age_below_threshold_rejected` (fails with "Age below threshold")
2. **CIRC-03 (Schnorr signature verification)**: Verified by `test_wrong_signature_rejected` (fails on invalid signature)
3. **CIRC-04 (expiration check)**: Verified by `test_expired_credential_rejected` (fails with "Credential has expired")
4. **CIRC-05 (per-dApp nullifiers)**: Verified by `test_different_context_different_nullifier` and `test_same_context_same_nullifier`
5. **CIRC-06 (clean public outputs)**: Verified by inspecting public_inputs file -- only nullifier, pub_key_x, pub_key_y, current_timestamp, threshold, dapp_context_id, attribute_key present

End-to-end pipeline: nargo build + test + execute, bb write_vk + prove + verify all exit 0.
</verification>

<success_criteria>
- `nargo test --package age_verify` passes all 6 tests
- `nargo info --package age_verify` reports ACIR opcode count < 5,000
- `bb verify` exits 0 with "Proof verified successfully" for a valid credential proof
- Public output ordering is documented in main.nr
- No private data (subject_id, attribute_value, secret_salt, issued_at, expires_at) appears in public_inputs
- issuer.ts supports --expired and --young flags for test fixture generation
</success_criteria>

<output>
After completion, create `.planning/phases/02-age-verification-circuit/02-01-SUMMARY.md`
</output>
