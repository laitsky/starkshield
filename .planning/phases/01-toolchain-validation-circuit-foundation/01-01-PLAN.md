---
phase: 01-toolchain-validation-circuit-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .tool-versions
  - circuits/Nargo.toml
  - circuits/crates/trivial/Nargo.toml
  - circuits/crates/trivial/src/main.nr
  - circuits/crates/trivial/Prover.toml
  - circuits/crates/shared_lib/Nargo.toml
  - circuits/crates/shared_lib/src/lib.nr
  - contracts/Scarb.toml
  - contracts/src/lib.cairo
autonomous: true

must_haves:
  truths:
    - "nargo 1.0.0-beta.18 compiles a trivial Noir circuit without errors"
    - "bb write_vk and bb prove generate a valid VK and proof that bb verify accepts"
    - "garaga gen produces a Cairo verifier contract from the Noir VK without errors"
    - "scarb build compiles the Garaga-generated Cairo verifier under Scarb 2.15.x"
    - "nargo info reports constraint count for the trivial circuit"
  artifacts:
    - path: ".tool-versions"
      provides: "Pinned tool versions for reproducible builds"
      contains: "noir 1.0.0-beta.18"
    - path: "circuits/Nargo.toml"
      provides: "Noir workspace root configuration"
      contains: "[workspace]"
    - path: "circuits/crates/trivial/src/main.nr"
      provides: "Trivial spike circuit for pipeline validation"
      contains: "fn main"
    - path: "circuits/crates/trivial/Prover.toml"
      provides: "Default prover inputs for trivial circuit"
    - path: "contracts/Scarb.toml"
      provides: "Cairo contract workspace with Garaga dependency"
      contains: "garaga"
    - path: "contracts/src/lib.cairo"
      provides: "Cairo module declarations for generated verifier"
  key_links:
    - from: "circuits/crates/trivial/src/main.nr"
      to: "circuits/target/trivial.json"
      via: "nargo build compilation"
      pattern: "nargo build"
    - from: "circuits/target/trivial.json"
      to: "circuits/target/vk"
      via: "bb write_vk"
      pattern: "bb write_vk -s ultra_honk"
    - from: "circuits/target/vk"
      to: "contracts/src/"
      via: "garaga gen"
      pattern: "garaga gen --system ultra_keccak_zk_honk"
    - from: "contracts/src/"
      to: "contracts/target/"
      via: "scarb build"
      pattern: "scarb build"
---

<objective>
Install and pin the full ZK toolchain (Noir, Barretenberg, Garaga, Scarb), scaffold the project directory structure, and validate the complete compile-prove-verify pipeline end-to-end with a trivial circuit.

Purpose: This is the Day 1 spike. Nothing else in the project can proceed until we confirm that nargo beta.18 circuits produce proofs that Garaga v1.0.1 can turn into Cairo verifiers compilable under Scarb 2.15.x. The primary risk -- Garaga/Noir version compatibility -- is resolved here. If the spike fails, the fallback is downgrading nargo to beta.16.

Output: Validated toolchain, project scaffold (circuits/ workspace + contracts/ workspace), compiled trivial circuit with proof, Garaga-generated Cairo verifier that compiles.
</objective>

<execution_context>
@/Users/laitsky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laitsky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-toolchain-validation-circuit-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install toolchain and scaffold project structure</name>
  <files>
    .tool-versions
    circuits/Nargo.toml
    circuits/crates/trivial/Nargo.toml
    circuits/crates/trivial/src/main.nr
    circuits/crates/trivial/Prover.toml
    circuits/crates/shared_lib/Nargo.toml
    circuits/crates/shared_lib/src/lib.nr
    contracts/Scarb.toml
    contracts/src/lib.cairo
  </files>
  <action>
    **1. Install Noir toolchain (nargo + bb):**
    - Install noirup: `curl -L https://raw.githubusercontent.com/noir-lang/noirup/refs/heads/main/install | bash`
    - Pin version: `noirup --version 1.0.0-beta.18`
    - Install bbup: `curl -L https://raw.githubusercontent.com/AztecProtocol/barretenberg/refs/heads/master/bbup/install | bash`
    - Auto-match bb to nargo: `bbup`
    - Verify: `nargo --version` shows `1.0.0-beta.18`, `bb --version` shows a matching version

    **2. Install Starknet toolchain (Scarb):**
    - If not installed: `curl -L https://raw.githubusercontent.com/software-mansion/starkup/refs/heads/main/install.sh | bash`
    - Verify: `scarb --version` shows `2.15.x`

    **3. Set up Python 3.10 virtual environment for Garaga:**
    - Confirm Python 3.10 is available: `python3.10 --version`
    - If not: use pyenv to install: `pyenv install 3.10.14 && pyenv local 3.10.14`
    - Create venv: `python3.10 -m venv .venv`
    - Activate: `source .venv/bin/activate`
    - Install Garaga: `pip install garaga==1.0.1`
    - Verify: `garaga --help` shows usage information

    **4. Create `.tool-versions` in project root:**
    ```
    noir 1.0.0-beta.18
    scarb 2.15.2
    python 3.10.14
    ```

    **5. Scaffold Noir workspace:**
    - Create directory structure: `circuits/crates/trivial/src/`, `circuits/crates/shared_lib/src/`
    - Create `circuits/Nargo.toml` (workspace root):
      ```toml
      [workspace]
      members = ["crates/shared_lib", "crates/trivial"]
      default-member = "crates/trivial"
      ```
    - Create `circuits/crates/shared_lib/Nargo.toml`:
      ```toml
      [package]
      name = "shared_lib"
      type = "lib"
      compiler_version = ">=0.36.0"

      [dependencies]
      poseidon = { tag = "v0.2.3", git = "https://github.com/noir-lang/poseidon" }
      schnorr = { tag = "v0.1.3", git = "https://github.com/noir-lang/schnorr" }
      ```
    - Create `circuits/crates/shared_lib/src/lib.nr` as empty placeholder:
      ```noir
      // Shared library - crypto primitives for StarkShield circuits
      // Modules will be added in Plan 01-02
      ```
    - Create `circuits/crates/trivial/Nargo.toml`:
      ```toml
      [package]
      name = "trivial"
      type = "bin"
      compiler_version = ">=0.36.0"

      [dependencies]
      poseidon = { tag = "v0.2.3", git = "https://github.com/noir-lang/poseidon" }
      ```
      NOTE: The trivial circuit does NOT depend on shared_lib yet (shared_lib is empty). It imports poseidon directly for the spike. Plan 01-02 will add shared_lib integration.
    - Create `circuits/crates/trivial/src/main.nr`:
      ```noir
      use dep::poseidon::poseidon2;

      fn main(x: Field, y: Field, result: pub Field) {
          let hash = poseidon2::hash([x, y]);
          assert(hash == result);
      }
      ```
      This is the minimal circuit: hash two private inputs, assert they match a public output. Validates Poseidon2 works end-to-end.
    - Create `circuits/crates/trivial/Prover.toml` with test values. To get the correct `result` value: first compile the circuit, then compute the hash in a Noir test or set a placeholder and update after first execution. Initial approach: use known test vector or compute via nargo test. Simplest: just set `x = "1"`, `y = "2"`, `result = "0"` as placeholder, then update result after `nargo execute` reveals the actual hash value from the witness.

    **6. Scaffold contracts workspace:**
    - Create `contracts/src/` directory
    - Create `contracts/Scarb.toml`:
      ```toml
      [package]
      name = "starkshield_contracts"
      version = "0.1.0"
      edition = "2024_07"

      [dependencies]
      starknet = "2.15.0"
      garaga = "1.0.1"

      [[target.starknet-contract]]
      sierra = true
      ```
    - Create `contracts/src/lib.cairo` as placeholder:
      ```cairo
      // Module declarations will be added after garaga gen
      ```

    **7. Version verification checklist (run all, record output):**
    - `nargo --version` => 1.0.0-beta.18
    - `bb --version` => compatible nightly
    - `scarb --version` => 2.15.x
    - `python --version` (in .venv) => 3.10.x
    - `garaga --help` => shows usage
  </action>
  <verify>
    Run all version checks and confirm:
    1. `nargo --version` outputs `nargo version = 1.0.0-beta.18`
    2. `bb --version` outputs a version string (auto-matched)
    3. `scarb --version` outputs `scarb 2.15.x`
    4. `source .venv/bin/activate && python --version` outputs `Python 3.10.x`
    5. `source .venv/bin/activate && garaga --help` outputs usage without errors
    6. All files exist: `ls circuits/Nargo.toml circuits/crates/trivial/src/main.nr circuits/crates/trivial/Nargo.toml circuits/crates/shared_lib/Nargo.toml contracts/Scarb.toml`
    7. `cd circuits && nargo check` succeeds (validates Nargo.toml syntax and dependency resolution)
  </verify>
  <done>
    All five tools (nargo, bb, garaga, scarb, python 3.10) are installed at pinned versions. The Noir workspace compiles with `nargo check`. The contracts workspace exists with Garaga dependency declared. The project directory structure matches the architecture from research.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute full compile-prove-verify pipeline spike</name>
  <files>
    circuits/crates/trivial/Prover.toml
    contracts/src/lib.cairo
  </files>
  <action>
    **This is the critical validation spike. Execute each step sequentially. If ANY step fails, document the error and assess the fallback (downgrade to nargo beta.16).**

    **1. Compile the trivial circuit:**
    ```bash
    cd circuits && nargo build
    ```
    Verify: `circuits/target/trivial.json` exists (the compiled ACIR artifact).

    **2. Generate the verification key:**
    ```bash
    bb write_vk -s ultra_honk --oracle_hash keccak \
      -b target/trivial.json -o target/vk
    ```
    Verify: `circuits/target/vk` file exists (binary VK).

    **3. Generate Cairo verifier with Garaga:**
    ```bash
    source ../.venv/bin/activate
    garaga gen --system ultra_keccak_zk_honk \
      --vk target/vk --project-name contracts
    ```
    IMPORTANT: This is the CRITICAL compatibility test. If garaga gen fails on a beta.18 VK:
    - Document the exact error message
    - Immediately try the fallback: `noirup --version 1.0.0-beta.16 && bbup && nargo build` and retry
    - If beta.16 works, update `.tool-versions` and all `compiler_version` fields to match

    Verify: Cairo files generated in `contracts/src/` (look for `honk_verifier.cairo` or similar auto-generated files).

    **4. Update contracts/src/lib.cairo:**
    After garaga gen, inspect what files were generated in `contracts/src/`. Update `lib.cairo` to declare the generated modules. The exact module names depend on garaga's output, but typically:
    ```cairo
    mod honk_verifier;
    // plus any other generated files
    ```
    Do NOT edit the auto-generated files themselves.

    **5. Build Cairo contracts:**
    ```bash
    cd ../contracts && scarb build
    ```
    Verify: Build succeeds, Sierra artifacts exist in `contracts/target/`.

    **6. Execute witness and generate proof:**
    First, we need valid Prover.toml values. The `result` field must be the actual Poseidon2 hash of (x, y).

    Approach: Use `nargo execute` with a modified circuit that prints the hash, or compute the hash separately. Simplest approach:
    - Temporarily modify main.nr to NOT assert (just compute), run nargo execute to get the witness
    - OR: Use a Noir test to compute the hash and print it
    - OR: Set x=0, y=0 and compute Poseidon2(0,0) which has a known value

    Recommended approach: Create a temporary test in the trivial circuit that computes and prints the hash:
    ```noir
    #[test]
    fn test_hash() {
        let hash = poseidon2::hash([1, 2]);
        std::println(hash);
    }
    ```
    Run `nargo test --show-output` to get the hash value. Update Prover.toml with the correct result.

    Then execute:
    ```bash
    cd ../circuits
    nargo execute witness
    ```
    Verify: `circuits/target/witness.gz` exists.

    **7. Generate proof:**
    ```bash
    bb prove -s ultra_honk --oracle_hash keccak \
      -b target/trivial.json -w target/witness.gz -o target/
    ```
    Verify: `circuits/target/proof` file exists.

    **8. Verify proof locally:**
    ```bash
    bb verify -s ultra_honk --oracle_hash keccak \
      -k target/vk -p target/proof
    ```
    Verify: Exit code 0, output confirms verification passed.

    **9. Measure constraints:**
    ```bash
    nargo info
    ```
    Record the constraint count for the trivial circuit. This establishes the baseline. Expected: very low (a single Poseidon2 hash of 2 fields should be ~500-1000 constraints).

    **10. Pipeline summary:**
    After all steps pass, log the results:
    - nargo version used
    - bb version used
    - garaga version used
    - scarb version used
    - Constraint count from nargo info
    - Whether Garaga beta.18 compatibility is CONFIRMED or fallback was needed
  </action>
  <verify>
    Run the complete pipeline in sequence and confirm each step:
    1. `cd circuits && nargo build` exits 0 and `target/trivial.json` exists
    2. `bb write_vk -s ultra_honk --oracle_hash keccak -b target/trivial.json -o target/vk` exits 0
    3. `source ../.venv/bin/activate && garaga gen --system ultra_keccak_zk_honk --vk target/vk --project-name contracts` exits 0
    4. `cd ../contracts && scarb build` exits 0
    5. `cd ../circuits && nargo execute witness` exits 0 and `target/witness.gz` exists
    6. `bb prove -s ultra_honk --oracle_hash keccak -b target/trivial.json -w target/witness.gz -o target/` exits 0
    7. `bb verify -s ultra_honk --oracle_hash keccak -k target/vk -p target/proof` exits 0
    8. `nargo info` shows constraint count for trivial circuit
  </verify>
  <done>
    The full compile -> VK -> garaga gen -> scarb build -> execute -> prove -> verify pipeline completes successfully. Garaga v1.0.1 compatibility with nargo beta.18 is either CONFIRMED or the fallback version (beta.16) is documented and all configs updated. The trivial circuit's constraint count is recorded as a baseline measurement. The pipeline commands are known and reproducible.
  </done>
</task>

</tasks>

<verification>
Phase 1, Plan 01 is complete when:
1. All five tools are installed at correct pinned versions (nargo, bb, garaga, scarb, python 3.10)
2. The Noir workspace (`circuits/`) has a trivial circuit that compiles with `nargo build`
3. The Garaga-generated Cairo verifier compiles under `scarb build` without modifications
4. A proof generated from the trivial circuit passes local verification with `bb verify`
5. `nargo info` reports the constraint count for the trivial circuit
6. The Garaga/Noir beta.18 compatibility risk is resolved (confirmed working or fallback applied)
</verification>

<success_criteria>
- `nargo build`, `bb write_vk`, `garaga gen`, `scarb build`, `bb prove`, `bb verify` all exit 0 in sequence
- Constraint count is recorded and is a reasonable number for a single Poseidon2 hash
- If fallback to beta.16 was needed: all configs updated, all Nargo.toml compiler_version fields match, and the pipeline still passes end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/01-toolchain-validation-circuit-foundation/01-01-SUMMARY.md`
</output>
