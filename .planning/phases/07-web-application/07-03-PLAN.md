---
phase: 07-web-application
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - sdk/app/views/VerificationDashboard.tsx
  - sdk/app/hooks/useVerifications.ts
  - sdk/app/components/PrivacyCallout.tsx
  - sdk/app/components/ErrorBanner.tsx
autonomous: true

must_haves:
  truths:
    - "The Verification Dashboard displays past verifications loaded from localStorage with truncated nullifier, attribute type, timestamp, and clickable Starkscan transaction links"
    - "Privacy callout annotations appear at credential loading, proof generation, and before submission showing 'this data stays on your device'"
    - "Error messages are classified and actionable -- expired credential, wrong network, insufficient gas, rejected tx, WASM failure, and missing wallet each show specific guidance"
    - "Dashboard enriches local records with on-chain verification data via getVerificationRecord"
    - "Empty dashboard state shows a helpful message directing users to generate their first proof"
  artifacts:
    - path: "sdk/app/views/VerificationDashboard.tsx"
      provides: "Past verifications table with Starkscan links and on-chain enrichment"
    - path: "sdk/app/hooks/useVerifications.ts"
      provides: "Hook for loading, enriching, and managing verification records"
    - path: "sdk/app/components/PrivacyCallout.tsx"
      provides: "Reusable privacy annotation component for WEB-04"
    - path: "sdk/app/components/ErrorBanner.tsx"
      provides: "Error classification and actionable message display for WEB-06"
  key_links:
    - from: "sdk/app/views/VerificationDashboard.tsx"
      to: "sdk/src/reader.ts"
      via: "SDK getVerificationRecord for on-chain enrichment"
      pattern: "import.*getVerificationRecord.*from.*src/index"
    - from: "sdk/app/hooks/useVerifications.ts"
      to: "localStorage"
      via: "starkshield_verifications key for persistence"
      pattern: "localStorage.*starkshield_verifications"
    - from: "sdk/app/components/PrivacyCallout.tsx"
      to: "sdk/app/views/CredentialWallet.tsx"
      via: "Imported and rendered in Credential Wallet view"
      pattern: "PrivacyCallout"
---

<objective>
Build the Verification Dashboard (WEB-03), privacy callout annotations (WEB-04), and error handling components (WEB-06). Also integrate privacy callouts into the existing Credential Wallet and Proof Generator views.

Purpose: Completes the user-facing product by showing verification history, building trust through privacy transparency, and providing helpful error guidance.
Output: Verification Dashboard at /dashboard, PrivacyCallout component placed at key user touchpoints, ErrorBanner component for classified error display.
</objective>

<execution_context>
@/Users/laitsky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laitsky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-web-application/07-RESEARCH.md
@.planning/phases/07-web-application/07-01-SUMMARY.md
@.planning/phases/07-web-application/07-02-SUMMARY.md

# Source files to reference
@sdk/src/index.ts
@sdk/src/types.ts
@sdk/src/config.ts
@sdk/app/views/CredentialWallet.tsx
@sdk/app/views/ProofGenerator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build PrivacyCallout and ErrorBanner reusable components</name>
  <files>
    sdk/app/components/PrivacyCallout.tsx
    sdk/app/components/ErrorBanner.tsx
  </files>
  <action>
    **1. `sdk/app/components/PrivacyCallout.tsx`** -- WEB-04 privacy annotation:

    Follow the research Pattern 4. Props: `{ context: 'credential' | 'proof' | 'submission' }`.

    Messages per context:
    - `credential`: "Your credential data stays on your device. It is never uploaded to any server."
    - `proof`: "Proof generation happens entirely in your browser. Only the ZK proof (not your data) will be shared."
    - `submission`: "Only the proof and public outputs go on-chain. Your actual age, identity, and credential details remain private."

    Styling: Green-tinted callout box with a lock icon (use the Unicode lock character U+1F512 or a simple SVG shield icon). Use Tailwind: `border border-green-700/40 bg-green-950/30 rounded-lg px-4 py-3 text-sm text-green-300`. Flex layout with icon on left, message on right.

    Export as default. Accessible -- include `role="note"` and `aria-label="Privacy notice"`.

    **2. `sdk/app/components/ErrorBanner.tsx`** -- WEB-06 error classification and display:

    Follow the research Pattern 6. Props: `{ error: string; onDismiss?: () => void }`.

    Implement `classifyError(error: string)` that returns `{ title: string; message: string; action: string }`.

    Classification rules (check error message string for patterns):
    - **Expired credential**: matches 'expired' or 'expir' -> Title: "Credential Expired", Action: "Request a new credential from the issuer."
    - **Wrong network**: matches 'network', 'chain', 'SN_SEPOLIA' -> Title: "Wrong Network", Action: "Switch your wallet to Starknet Sepolia in your wallet settings."
    - **Insufficient gas**: matches 'gas', 'fee', 'insufficient' -> Title: "Insufficient Gas", Action: "Add funds to your Sepolia wallet via a faucet."
    - **Rejected transaction**: matches 'rejected', 'User abort', 'cancel' -> Title: "Transaction Rejected", Action: "Try again and approve the transaction when prompted."
    - **WASM failure**: matches 'wasm', 'WASM', 'WebAssembly' -> Title: "WASM Load Failure", Action: "Try refreshing the page. Ensure you are using a modern browser (Chrome, Firefox, Safari)."
    - **Missing wallet**: matches 'wallet', 'No wallet', 'not installed' -> Title: "Wallet Not Found", Action: "Install ArgentX or Braavos wallet extension and refresh the page."
    - **Default fallback**: Title: "Error", Action: "Try again. If the problem persists, refresh the page."

    Styling: Red-tinted banner with title, message, action text, and optional dismiss (X) button. Use Tailwind: `border border-red-700/40 bg-red-950/30 rounded-lg px-4 py-3 text-red-300`.

    Structure:
    ```
    [X]  Title
         Message
         Action (in slightly different color, e.g., text-red-200)
    ```

    Export as default.
  </action>
  <verify>
    - `cd sdk && npx tsc --noEmit` exits 0
    - PrivacyCallout renders different messages for 'credential', 'proof', 'submission' contexts
    - ErrorBanner classifies all 6 error types with distinct titles and actions
    - Both components use Tailwind classes and have accessible markup
  </verify>
  <done>
    PrivacyCallout component provides context-aware privacy annotations for WEB-04. ErrorBanner provides classified, actionable error messages for all 6 WEB-06 error types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Verification Dashboard view and integrate privacy callouts across views</name>
  <files>
    sdk/app/views/VerificationDashboard.tsx
    sdk/app/hooks/useVerifications.ts
    sdk/app/views/CredentialWallet.tsx
    sdk/app/views/ProofGenerator.tsx
  </files>
  <action>
    **1. `sdk/app/hooks/useVerifications.ts`** -- Hook for verification history:

    Define stored verification interface:
    ```typescript
    interface StoredVerification {
      txHash: string;
      nullifier: string;
      circuitType: 'age_verify' | 'membership_proof';
      timestamp: number;
      attributeKey: string;
      threshold: string;
      // Enriched from on-chain (optional, added after query)
      onChainTimestamp?: number;
      onChainCircuitId?: number;
      confirmed?: boolean;
    }
    ```

    The hook provides:
    - `verifications`: StoredVerification[] -- loaded from localStorage key `starkshield_verifications`
    - `loading`: boolean -- true while enriching with on-chain data
    - `enrichWithOnChain()`: For each verification, call `getVerificationRecord(nullifier)` from the SDK. If the on-chain record exists, update the stored record with `onChainTimestamp`, `onChainCircuitId`, and `confirmed: true`. Update localStorage after enrichment.
    - `clearHistory()`: Clear all stored verifications from localStorage

    Load verifications from localStorage on mount. Call enrichWithOnChain() once on mount (wrapped in try-catch, non-blocking -- dashboard should show local data immediately, then update with on-chain status).

    Import `getVerificationRecord` from `../../src/index`.

    STORAGE_KEY constant: `'starkshield_verifications'`

    **2. `sdk/app/views/VerificationDashboard.tsx`** -- WEB-03 dashboard:

    Replace the placeholder with the full implementation.

    **View Layout:**

    a. **Header section:** "Verification Dashboard" title with subtitle "Your past proof verifications"

    b. **Verifications list:** For each stored verification, display a card with:
       - **Circuit type badge:** "Age Verification" (violet badge) or "Membership Verification" (blue badge)
       - **Nullifier:** Truncated hex (`0x1b29...982d`) -- use `truncateHex(hex, 6, 4)` utility
       - **Attribute:** Hex value of attributeKey
       - **Threshold/Set Hash:** Hex value
       - **Timestamp:** Human-readable date from `new Date(v.timestamp).toLocaleString()`
       - **Transaction link:** Clickable link "View on Starkscan" -> `https://sepolia.starkscan.co/tx/${v.txHash}`. Open in new tab (`target="_blank" rel="noopener noreferrer"`).
       - **On-chain status indicator:** If `confirmed === true`, show green "Confirmed on-chain" badge. If `confirmed === undefined` (not yet enriched), show gray "Checking..." with subtle animation. If enrichment ran but record not found, show yellow "Pending" badge.

    c. **Empty state:** If no verifications exist, show a centered message: "No verifications yet. Generate and submit a proof to see it here." with a link/button to navigate to /prove.

    d. **Clear history button:** "Clear History" button at the bottom (with confirmation).

    Utility function:
    ```typescript
    function truncateHex(hex: string, start = 6, end = 4): string {
      if (hex.length <= start + end + 2) return hex;
      return `${hex.slice(0, start + 2)}...${hex.slice(-end)}`;
    }
    ```

    **3. Integrate PrivacyCallout into CredentialWallet.tsx:**
    - Add `<PrivacyCallout context="credential" />` above or below the credentials list.
    - Import from `../components/PrivacyCallout`.

    **4. Integrate PrivacyCallout into ProofGenerator.tsx:**
    - Add `<PrivacyCallout context="proof" />` in the proof generation section (near the "Generate Proof" button).
    - Add `<PrivacyCallout context="submission" />` in the public output preview section (before the "Submit On-Chain" button).
    - Replace any inline error display with the `<ErrorBanner error={error} onDismiss={reset} />` component.
    - Import PrivacyCallout and ErrorBanner from `../components/`.

    All styling with Tailwind. Dark theme consistent with Layout.
  </action>
  <verify>
    - `cd sdk && npx tsc --noEmit` exits 0
    - VerificationDashboard reads from localStorage and displays verification cards
    - Each card has a Starkscan link with correct URL format
    - Nullifiers are truncated to `0xABCDEF...1234` format
    - PrivacyCallout appears in CredentialWallet (context="credential")
    - PrivacyCallout appears twice in ProofGenerator (context="proof" and context="submission")
    - ErrorBanner is used in ProofGenerator for error display
    - Empty dashboard state shows helpful message with link to /prove
  </verify>
  <done>
    Verification Dashboard displays past verifications with truncated nullifiers, attribute info, timestamps, and Starkscan links. On-chain enrichment confirms verification status. Privacy callouts appear at credential loading, proof generation, and before submission. Error messages are classified and actionable. All WEB-03, WEB-04, and WEB-06 requirements are met.
  </done>
</task>

</tasks>

<verification>
1. `cd sdk && npx tsc --noEmit` passes with zero errors
2. Navigate to /dashboard -- shows verification history (or empty state if none)
3. Each verification card shows: circuit type badge, truncated nullifier, attribute, timestamp, Starkscan link
4. Clicking Starkscan link opens correct transaction URL in new tab
5. PrivacyCallout with "credential" context visible in Credential Wallet view
6. PrivacyCallout with "proof" and "submission" contexts visible in Proof Generator view
7. Triggering each error type (expired, wrong network, gas, rejected, WASM, wallet) shows classified actionable message
8. Empty dashboard shows "No verifications yet" with link to /prove
9. "Clear History" button removes all verifications from localStorage
</verification>

<success_criteria>
The Verification Dashboard (WEB-03) displays all past verifications with Starkscan links and on-chain enrichment. Privacy callouts (WEB-04) appear at all three key user touchpoints. Error handling (WEB-06) classifies all 6 error types with user-actionable messages. The application satisfies all Phase 7 success criteria.
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-application/07-03-SUMMARY.md`
</output>
