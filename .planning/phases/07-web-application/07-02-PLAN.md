---
phase: 07-web-application
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - sdk/app/views/ProofGenerator.tsx
  - sdk/app/hooks/useProofGeneration.ts
  - sdk/app/components/ProofProgress.tsx
autonomous: true

must_haves:
  truths:
    - "User can select an attribute type (age or membership), set a threshold or select allowed set values, and start proof generation"
    - "Real-time step progress indicator shows which phase of proof generation is active (initializing, generating, calldata, submitting, complete)"
    - "After proof generation, public outputs are previewed before submission -- user sees nullifier, attribute key, threshold/set hash, and circuit type"
    - "User can submit the proof on-chain after previewing outputs, and sees the transaction hash on success"
    - "Proof generation for membership circuit shows allowed set input fields instead of threshold input"
  artifacts:
    - path: "sdk/app/views/ProofGenerator.tsx"
      provides: "Full proof generation view with attribute selector, threshold/set input, progress, preview, and submit"
    - path: "sdk/app/hooks/useProofGeneration.ts"
      provides: "Hook managing proof generation lifecycle with step tracking"
    - path: "sdk/app/components/ProofProgress.tsx"
      provides: "Step-based progress indicator for proof generation pipeline"
  key_links:
    - from: "sdk/app/views/ProofGenerator.tsx"
      to: "sdk/src/prover.ts"
      via: "SDK generateAgeProof/generateMembershipProof"
      pattern: "import.*generate.*Proof.*from.*src/index"
    - from: "sdk/app/views/ProofGenerator.tsx"
      to: "sdk/src/submitter.ts"
      via: "SDK generateCalldata/submitProof"
      pattern: "import.*submitProof.*from.*src/index"
    - from: "sdk/app/hooks/useProofGeneration.ts"
      to: "sdk/src/init.ts"
      via: "SDK initWasm for WASM initialization gate"
      pattern: "import.*initWasm.*from.*src/index"
---

<objective>
Build the Proof Generator view (WEB-02) with attribute selection, threshold/set input, real-time proof generation progress, public output preview before submission, and on-chain proof submission.

Purpose: The core user workflow -- generating and submitting ZK proofs. This view orchestrates the entire flow from credential selection through on-chain verification.
Output: Fully functional Proof Generator view at /prove.
</objective>

<execution_context>
@/Users/laitsky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laitsky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-web-application/07-RESEARCH.md
@.planning/phases/07-web-application/07-01-SUMMARY.md

# Source files to reference
@sdk/src/index.ts
@sdk/src/types.ts
@sdk/src/config.ts
@sdk/app/context/WalletContext.tsx
@sdk/app/hooks/useWallet.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build proof generation hook and progress indicator component</name>
  <files>
    sdk/app/hooks/useProofGeneration.ts
    sdk/app/components/ProofProgress.tsx
  </files>
  <action>
    **1. `sdk/app/hooks/useProofGeneration.ts`** -- Custom hook managing the full proof lifecycle:

    Define step type: `'idle' | 'initializing' | 'generating' | 'calldata' | 'previewing' | 'submitting' | 'complete' | 'error'`

    State interface:
    ```typescript
    interface ProofState {
      step: ProofStep;
      proofResult: ProofResult | null;
      calldataResult: CalldataResult | null;
      submitResult: SubmitResult | null;
      error: string | null;
    }
    ```

    Expose three async functions:
    - `generateProof(credential, circuitType, params)`: Sets step to 'initializing' -> calls initWasm() -> sets step to 'generating' -> calls generateAgeProof or generateMembershipProof based on circuitType -> sets step to 'idle' with proofResult -> returns proofResult. On error, sets step to 'error' with message.
    - `prepareCalldata(proofResult, circuitType)`: Sets step to 'calldata' -> calls generateCalldata(proofResult, circuitType) -> sets step to 'previewing' with calldataResult -> returns calldataResult.
    - `submitOnChain(walletAccount, calldataResult)`: Sets step to 'submitting' -> calls submitProof(walletAccount, calldataResult) -> sets step to 'complete' with submitResult -> returns submitResult.
    - `reset()`: Resets all state back to initial values.

    Import from SDK: `initWasm`, `generateAgeProof`, `generateMembershipProof`, `generateCalldata`, `submitProof`, and the types `ProofResult`, `CalldataResult`, `SubmitResult`, `CredentialJSON`, `CircuitType`, `AgeProofParams`, `MembershipProofParams`.

    Also expose: a `publicOutputs` derived value that extracts readable fields from `proofResult.publicInputs` when available:
    - For age_verify (9 public inputs): { threshold: [0], dappContextId: [1], currentTimestamp: [2], issuerPubKeyX: [3], issuerPubKeyY: [4], nullifier: [5], echoedAttributeKey: [6], echoedThreshold: [7], echoedIssuerX: [8] }
    - For membership_proof (16 public inputs): { dappContextId: [0], currentTimestamp: [1], issuerPubKeyX: [2], issuerPubKeyY: [3], allowedSet: [4..11], nullifier: [12], echoedAttributeKey: [13], setHash: [14], echoedIssuerX: [15] }
    Parse these into a structured object for display in the preview step.

    **2. `sdk/app/components/ProofProgress.tsx`** -- Step-based progress indicator:

    Display a vertical list of proof generation steps. Follow the Pattern from research (research section "Proof Progress Indicator").

    Steps: Initializing proof engine -> Generating ZK proof -> Preparing transaction data -> Previewing outputs -> Submitting to Starknet -> Verification complete.

    For each step:
    - Completed steps: green checkmark + green text
    - Current step: blue dot + blue text + animated pulse (Tailwind `animate-pulse` on the dot)
    - Future steps: gray circle + gray text
    - Error step: red X + red text

    Props: `{ currentStep: ProofStep }`. Return null if step is 'idle'.

    Use Tailwind classes for all styling. Dark theme consistent with Layout (gray-900 backgrounds, green/blue/red accent colors).
  </action>
  <verify>
    - `cd sdk && npx tsc --noEmit` exits 0
    - Both files exist with correct TypeScript/React code
    - ProofProgress component handles all step states including error
    - useProofGeneration hook imports all required SDK functions
  </verify>
  <done>
    Proof generation hook manages the full lifecycle (init -> generate -> calldata -> preview -> submit) with step tracking and error handling. Progress indicator component shows real-time step status with visual feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the Proof Generator view with credential selection, input forms, output preview, and submit</name>
  <files>
    sdk/app/views/ProofGenerator.tsx
  </files>
  <action>
    Replace the placeholder ProofGenerator.tsx with the full implementation:

    **View Layout (top to bottom):**

    1. **Credential Selection Section:**
       - Check `useLocation().state?.credential` for a credential passed from the Credential Wallet view.
       - If present, show the selected credential as a compact card (name, type, issuer truncated, expiration status).
       - If not present, show a "Select Credential" prompt with two buttons: "Load Age Demo" and "Load Membership Demo" that fetch from `/credentials/demo_credential.json` and `/credentials/demo_credential_membership.json` respectively. Also allow file upload via `<input type="file" accept=".json" />`.
       - Determine circuitType from credential: `BigInt(credential.credential_type) === 0n ? 'age_verify' : 'membership_proof'`

    2. **Proof Parameters Section** (shown after credential is selected):
       - For age_verify: A threshold number input (default 18) and a dApp Context ID number input (default 42).
       - For membership_proof: An allowed set input -- show the default allowed set values from the demo (`0x64`, `0x65`, `0x66`) in a comma-separated text input. Parse comma-separated hex values. Also a dApp Context ID input (default 42).
       - A "Generate Proof" button (disabled if no credential selected or if proof is in progress).

    3. **Progress Section** (shown during proof generation):
       - Render the `<ProofProgress currentStep={step} />` component.
       - Below progress, show elapsed time counter (update every second via setInterval while step is not idle/complete/error).

    4. **Public Output Preview Section** (shown when step is 'previewing'):
       - Display the structured public outputs from `useProofGeneration().publicOutputs`:
         - Nullifier (full hex, with copy-to-clipboard button)
         - Attribute key (hex)
         - Threshold or Set Hash (hex)
         - Circuit type (human-readable: "Age Verification" or "Membership Verification")
       - Privacy callout: "Only these public outputs go on-chain. Your credential data stays on your device." (Use a simple inline callout; the PrivacyCallout component will be built in 07-03 and can be swapped in later).
       - Two buttons: "Submit On-Chain" (primary, calls prepareCalldata then submitOnChain) and "Cancel" (resets state).
       - "Submit On-Chain" button should be disabled if wallet is not connected -- show "Connect wallet to submit" message.

    5. **Result Section** (shown when step is 'complete'):
       - Transaction hash with Starkscan link: `https://sepolia.starkscan.co/tx/{txHash}`
       - Nullifier value (truncated)
       - "Proof submitted successfully!" success message
       - Persist the verification to localStorage for the Verification Dashboard:
         Store `{ txHash, nullifier, circuitType, timestamp: Date.now(), attributeKey, threshold }` in a `starkshield_verifications` localStorage key (JSON array, newest first).
       - "Generate Another Proof" button that resets state.

    6. **Error Section** (shown when step is 'error'):
       - Display the error message in a red banner.
       - Classify the error using a simple inline classifier (match patterns: 'expired', 'network'/'SN_SEPOLIA', 'gas'/'insufficient', 'rejected'/'cancel', 'wasm'/'WASM', 'wallet'/'not installed') and show actionable message. The full ErrorBanner component is built in 07-03; for now use an inline implementation.
       - "Try Again" button that resets state.

    **Imports:** useProofGeneration hook, ProofProgress component, useWallet hook, useLocation/useNavigate from react-router-dom, SDK types.

    **Critical implementation detail:** When generating proof for age_verify, pass `{ threshold, dappContextId, currentTimestamp: Math.floor(Date.now() / 1000) }` as AgeProofParams. For membership, pass `{ allowedSet: parsedHexArray, dappContextId, currentTimestamp: Math.floor(Date.now() / 1000) }` as MembershipProofParams.

    **Critical implementation detail for submit flow:** After user clicks "Generate Proof", the hook runs through initializing -> generating. Then automatically call prepareCalldata to transition to 'previewing'. The user previews public outputs, then clicks "Submit On-Chain" which calls submitOnChain. This is a 2-stage user flow: generate -> preview+submit.

    **localStorage persistence for dashboard:**
    ```typescript
    const STORAGE_KEY = 'starkshield_verifications';
    function saveVerification(v: { txHash: string; nullifier: string; circuitType: string; timestamp: number; attributeKey: string; threshold: string }) {
      const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      existing.unshift(v);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
    }
    ```
    Call this after successful submission in the complete handler.

    All styling with Tailwind. Dark theme. Consistent with Layout from 07-01.
  </action>
  <verify>
    - `cd sdk && npx tsc --noEmit` exits 0
    - `sdk/app/views/ProofGenerator.tsx` exports a default component
    - View handles both age_verify and membership_proof circuit types
    - localStorage persistence code is present
    - Starkscan link construction uses `https://sepolia.starkscan.co/tx/` prefix
    - Error classification handles all 6 error types from WEB-06
  </verify>
  <done>
    Proof Generator view at /prove supports the complete proof workflow: credential selection (from navigation state or demo loading), parameter input (threshold for age, allowed set for membership), real-time proof generation progress, public output preview before submission, on-chain submission with wallet, and result display with Starkscan link. Verification history is persisted to localStorage for the dashboard.
  </done>
</task>

</tasks>

<verification>
1. `cd sdk && npx tsc --noEmit` passes with zero errors
2. Navigate to /prove -- view loads with credential selection options
3. Selecting an age credential shows threshold input; selecting membership shows allowed set input
4. Clicking "Generate Proof" shows step-by-step progress indicator
5. After generation, public outputs are displayed for preview before submission
6. With wallet connected, "Submit On-Chain" sends the transaction
7. On success, Starkscan link is displayed and verification is persisted to localStorage
8. On error, actionable error message is shown with retry option
</verification>

<success_criteria>
The Proof Generator view implements the complete WEB-02 workflow: attribute/credential selection, threshold/set input, real-time progress indicator, public output preview before submission, and on-chain submission. localStorage persistence bridges to the Verification Dashboard.
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-application/07-02-SUMMARY.md`
</output>
