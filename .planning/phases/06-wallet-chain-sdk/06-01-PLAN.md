---
phase: 06-wallet-chain-sdk
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sdk/package.json
  - sdk/src/config.ts
  - sdk/src/wallet.ts
  - sdk/src/submitter.ts
  - sdk/src/types.ts
  - sdk/src/index.ts
  - sdk/vite.config.ts
autonomous: true

must_haves:
  truths:
    - "User can connect ArgentX or Braavos wallet and the SDK exposes the connected account address"
    - "A browser-generated proof can be transformed into garaga calldata and submitted to StarkShieldRegistry via a wallet-signed transaction"
    - "The SDK returns the transaction hash after successful submission"
  artifacts:
    - path: "sdk/src/config.ts"
      provides: "Contract addresses, RPC URL, circuit ID mappings"
      contains: "REGISTRY_ADDRESS"
    - path: "sdk/src/wallet.ts"
      provides: "Wallet connection via get-starknet v4 + WalletAccount"
      exports: ["connectWallet", "disconnectWallet"]
    - path: "sdk/src/submitter.ts"
      provides: "Proof-to-calldata transformation via garaga + transaction submission"
      exports: ["generateCalldata", "submitProof"]
    - path: "sdk/src/types.ts"
      provides: "WalletState, SubmitResult, CalldataResult types"
      contains: "SubmitResult"
    - path: "sdk/src/index.ts"
      provides: "Re-exports wallet, submitter, config modules"
      contains: "from './wallet'"
  key_links:
    - from: "sdk/src/submitter.ts"
      to: "garaga"
      via: "getZKHonkCallData(proofBytes, publicInputsBytes, vkBytes)"
      pattern: "getZKHonkCallData"
    - from: "sdk/src/submitter.ts"
      to: "sdk/src/wallet.ts"
      via: "WalletAccount.execute() for transaction submission"
      pattern: "walletAccount\\.execute"
    - from: "sdk/src/wallet.ts"
      to: "@starknet-io/get-starknet"
      via: "connect() for wallet discovery"
      pattern: "connect\\("
    - from: "sdk/src/submitter.ts"
      to: "sdk/src/config.ts"
      via: "REGISTRY_ADDRESS for transaction target"
      pattern: "REGISTRY_ADDRESS"
---

<objective>
Create the wallet connection and proof submission modules for the StarkShield SDK, enabling users to connect their Starknet wallet (ArgentX or Braavos) and submit browser-generated ZK proofs to the on-chain StarkShieldRegistry contract.

Purpose: This is the critical "write path" -- bridging browser-side proof generation (Phase 5) to on-chain verification (Phase 4 contracts). Without this, proofs exist only client-side.

Output: Four new SDK modules (config.ts, wallet.ts, submitter.ts, updated types.ts), updated barrel export, VK static assets bundled, and starknet.js + get-starknet dependencies installed.
</objective>

<execution_context>
@/Users/laitsky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laitsky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-wallet-chain-sdk/06-RESEARCH.md
@.planning/phases/05-proof-engine-sdk/05-01-SUMMARY.md
@.planning/phases/04-smart-contracts-deployment/04-02-SUMMARY.md
@sdk/src/types.ts
@sdk/src/index.ts
@sdk/src/prover.ts
@sdk/src/init.ts
@sdk/package.json
@sdk/vite.config.ts
@contracts/src/registry.cairo
@deployments.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create config module, and bundle VK static assets</name>
  <files>
    sdk/package.json
    sdk/src/config.ts
    sdk/public/vk/age_verify.vk
    sdk/public/vk/membership_proof.vk
  </files>
  <action>
    **Step 1: Install starknet.js v8 and get-starknet v4**
    ```bash
    cd sdk && npm install starknet@8.9.2 @starknet-io/get-starknet@4
    ```

    **Step 2: Copy VK files to sdk/public/vk/**

    Create `sdk/public/vk/` directory and copy the verification key binary files from the circuit build output:
    ```bash
    mkdir -p sdk/public/vk
    cp circuits/target/age_verify_vk/vk sdk/public/vk/age_verify.vk
    cp circuits/target/membership_proof_vk/vk sdk/public/vk/membership_proof.vk
    ```

    These are static binary files (~1888 bytes each) that do not change between sessions. They are needed by garaga's `getZKHonkCallData` to generate calldata.

    **Step 3: Create `sdk/src/config.ts`**

    This module centralizes all chain-related constants. All values come from `deployments.json` and Phase 4 decisions:

    ```typescript
    // Contract addresses from deployments.json
    export const REGISTRY_ADDRESS = '0x054ca264033ae3b5874574c84de9c6086d94a66fb65445e455a8cef3137b7fab';
    export const AGE_VERIFIER_ADDRESS = '0x9afed88f1d6bb0da51d98d29a3aaca31ed7ca99dc51a3df06931c543694f52';
    export const MEMBERSHIP_VERIFIER_ADDRESS = '0x483b48c3dbd32ebbc45b22a2a419c9a95c3999b103f5eb4a3048a0e8000d1da';

    // RPC URL -- same endpoint validated in Phase 4
    export const SEPOLIA_RPC_URL = 'https://free-rpc.nethermind.io/sepolia-juno/v0_8';

    // Starknet Sepolia chain ID
    export const SEPOLIA_CHAIN_ID = '0x534e5f5345504f4c4941'; // SN_SEPOLIA

    // Circuit ID mapping (matches registry.cairo constructor: 0=age, 1=membership)
    export const CIRCUIT_IDS = {
      age_verify: 0,
      membership_proof: 1,
    } as const;

    // VK asset paths (served from sdk/public/vk/ by Vite)
    export const VK_PATHS = {
      age_verify: '/vk/age_verify.vk',
      membership_proof: '/vk/membership_proof.vk',
    } as const;
    ```

    **Step 4: Update `sdk/vite.config.ts`**

    The COOP/COEP headers may block the get-starknet wallet modal. Per research open question #3, use `credentialless` instead of `require-corp` for COEP -- this is less restrictive but still enables SharedArrayBuffer in Chrome and Firefox:

    Change:
    ```
    res.setHeader('Cross-Origin-Embedder-Policy', 'require-corp');
    ```
    to:
    ```
    res.setHeader('Cross-Origin-Embedder-Policy', 'credentialless');
    ```

    This allows the wallet modal to load cross-origin resources (extension injected content) while still enabling SharedArrayBuffer for bb.js WASM workers.

    Also add `@starknet-io/get-starknet` to the optimizeDeps.exclude list if it causes issues (test first without).
  </action>
  <verify>
    1. `cd sdk && npm ls starknet` shows starknet@8.9.2
    2. `cd sdk && npm ls @starknet-io/get-starknet` shows v4.x
    3. `ls sdk/public/vk/` shows age_verify.vk and membership_proof.vk
    4. `cat sdk/src/config.ts` shows REGISTRY_ADDRESS matching deployments.json
    5. TypeScript compiles: `cd sdk && npx tsc --noEmit` (no errors)
  </verify>
  <done>
    starknet@8.9.2 and @starknet-io/get-starknet@4 installed, VK files bundled as static assets in sdk/public/vk/, config.ts exports all contract addresses and chain constants, vite.config.ts updated for wallet modal compatibility, TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build wallet connection and proof submission modules</name>
  <files>
    sdk/src/wallet.ts
    sdk/src/submitter.ts
    sdk/src/types.ts
    sdk/src/index.ts
  </files>
  <action>
    **Step 1: Add new types to `sdk/src/types.ts`**

    Append these types (do NOT modify existing types):

    ```typescript
    /** Connected wallet state */
    export interface WalletState {
      address: string;
      chainId: string;
      connected: boolean;
    }

    /** Result from proof submission to on-chain registry */
    export interface SubmitResult {
      transactionHash: string;
      circuitId: number;
      success: boolean;
    }

    /** Result from calldata generation */
    export interface CalldataResult {
      calldata: bigint[];
      circuitType: CircuitType;
    }

    /** Verification record from on-chain query */
    export interface VerificationRecord {
      exists: boolean;
      nullifier: bigint;
      attributeKey: bigint;
      thresholdOrSetHash: bigint;
      timestamp: number;
      circuitId: number;
    }
    ```

    **Step 2: Create `sdk/src/wallet.ts`**

    Wallet connection module using get-starknet v4 + starknet.js WalletAccount:

    ```typescript
    import { connect, disconnect } from '@starknet-io/get-starknet';
    import { WalletAccount } from 'starknet';
    import { SEPOLIA_RPC_URL } from './config';
    import type { WalletState } from './types';

    let currentWalletAccount: WalletAccount | null = null;

    /**
     * Connect to a Starknet wallet (ArgentX or Braavos).
     * Opens the get-starknet modal for wallet selection.
     * Returns WalletAccount for transaction signing.
     */
    export async function connectWallet(): Promise<{ walletAccount: WalletAccount; state: WalletState }> {
      const selectedWallet = await connect({
        modalMode: 'alwaysAsk',
        modalTheme: 'dark',
      });

      if (!selectedWallet) {
        throw new Error('No wallet selected. User cancelled or no wallets installed.');
      }

      // Create WalletAccount -- private key stays in wallet extension
      const walletAccount = await WalletAccount.connect(
        { nodeUrl: SEPOLIA_RPC_URL },
        selectedWallet,
      );

      currentWalletAccount = walletAccount;

      const state: WalletState = {
        address: walletAccount.address,
        chainId: await walletAccount.getChainId(),
        connected: true,
      };

      return { walletAccount, state };
    }

    /**
     * Disconnect the current wallet.
     */
    export async function disconnectWallet(): Promise<void> {
      await disconnect();
      currentWalletAccount = null;
    }

    /**
     * Get the current WalletAccount if connected.
     */
    export function getWalletAccount(): WalletAccount | null {
      return currentWalletAccount;
    }
    ```

    **IMPORTANT for wallet.ts:** The `connect` import from `@starknet-io/get-starknet` may have different export shapes between v4 versions. If the named import `connect` does not exist, try `import getStarknet from '@starknet-io/get-starknet'` and use `getStarknet.connect()`. Check the package's actual exports at runtime if TypeScript complains.

    **Step 3: Create `sdk/src/submitter.ts`**

    This is the most critical module -- it bridges bb.js ProofData to garaga calldata to starknet.js transaction:

    ```typescript
    import { init as initGaraga, getZKHonkCallData } from 'garaga';
    import { WalletAccount } from 'starknet';
    import { REGISTRY_ADDRESS, CIRCUIT_IDS, VK_PATHS } from './config';
    import type { ProofResult, CircuitType, SubmitResult, CalldataResult } from './types';

    let garagaInitialized = false;

    /**
     * Ensure garaga WASM is initialized (idempotent).
     */
    async function ensureGaragaInit(): Promise<void> {
      if (garagaInitialized) return;
      await initGaraga();
      garagaInitialized = true;
    }

    /**
     * Convert publicInputs from string[] (hex field elements) to Uint8Array.
     *
     * Each public input is a 32-byte hex string (0x-prefixed).
     * This function converts them to a flat Uint8Array (N * 32 bytes).
     *
     * NOTE: flattenFieldsAsArray is NOT re-exported from @aztec/bb.js top-level
     * (only deflattenFields is). This is a 3-line reimplementation per research.
     */
    function flattenPublicInputs(publicInputs: string[]): Uint8Array {
      const result = new Uint8Array(publicInputs.length * 32);
      for (let i = 0; i < publicInputs.length; i++) {
        const hex = publicInputs[i].replace('0x', '').padStart(64, '0');
        for (let j = 0; j < 32; j++) {
          result[i * 32 + j] = parseInt(hex.substring(j * 2, j * 2 + 2), 16);
        }
      }
      return result;
    }

    /**
     * Generate garaga calldata from a browser-generated proof.
     *
     * Flow: init garaga WASM -> flatten public inputs -> fetch VK -> getZKHonkCallData
     *
     * @param proofResult - ProofResult from generateAgeProof or generateMembershipProof
     * @param circuitType - Which circuit the proof was generated for
     * @returns CalldataResult with bigint[] calldata ready for transaction submission
     */
    export async function generateCalldata(
      proofResult: ProofResult,
      circuitType: CircuitType,
    ): Promise<CalldataResult> {
      await ensureGaragaInit();

      // Step 1: proof bytes are already Uint8Array from bb.js
      const proofBytes = proofResult.proof;

      // Step 2: Convert publicInputs from string[] (hex) to Uint8Array
      const publicInputsBytes = flattenPublicInputs(proofResult.publicInputs);

      // Step 3: Load VK bytes (static asset served by Vite from public/vk/)
      const vkPath = VK_PATHS[circuitType];
      const vkResponse = await fetch(vkPath);
      if (!vkResponse.ok) {
        throw new Error(`Failed to load VK file from ${vkPath}: ${vkResponse.status}`);
      }
      const vkBytes = new Uint8Array(await vkResponse.arrayBuffer());

      // Step 4: Generate calldata via garaga WASM
      const calldata: bigint[] = getZKHonkCallData(proofBytes, publicInputsBytes, vkBytes);

      return { calldata, circuitType };
    }

    /**
     * Submit a proof to StarkShieldRegistry on-chain.
     *
     * Formats calldata for verify_and_register(circuit_id: u8, full_proof_with_hints: Span<felt252>)
     * and submits via the connected wallet.
     *
     * @param walletAccount - Connected WalletAccount from connectWallet()
     * @param calldataResult - CalldataResult from generateCalldata()
     * @returns SubmitResult with transaction hash
     */
    export async function submitProof(
      walletAccount: WalletAccount,
      calldataResult: CalldataResult,
    ): Promise<SubmitResult> {
      const circuitId = CIRCUIT_IDS[calldataResult.circuitType];
      const { calldata } = calldataResult;

      // Format calldata for verify_and_register:
      // arg 1: circuit_id (u8) -- single felt
      // arg 2: full_proof_with_hints (Span<felt252>) -- [length, ...elements]
      const txCalldata: string[] = [
        circuitId.toString(),
        calldata.length.toString(),
        ...calldata.map(v => '0x' + v.toString(16)),
      ];

      const result = await walletAccount.execute({
        contractAddress: REGISTRY_ADDRESS,
        entrypoint: 'verify_and_register',
        calldata: txCalldata,
      });

      // Wait for transaction acceptance (throws on rejection)
      await walletAccount.waitForTransaction(result.transaction_hash);

      return {
        transactionHash: result.transaction_hash,
        circuitId,
        success: true,
      };
    }
    ```

    **Step 4: Update `sdk/src/index.ts`**

    Add exports for the new modules after the existing exports:

    ```typescript
    // Wallet connection
    export { connectWallet, disconnectWallet, getWalletAccount } from './wallet';

    // Proof submission
    export { generateCalldata, submitProof } from './submitter';

    // Configuration
    export {
      REGISTRY_ADDRESS,
      SEPOLIA_RPC_URL,
      CIRCUIT_IDS,
      VK_PATHS,
    } from './config';

    // New types
    export type {
      WalletState,
      SubmitResult,
      CalldataResult,
      VerificationRecord,
    } from './types';
    ```
  </action>
  <verify>
    1. TypeScript compiles: `cd sdk && npx tsc --noEmit` (no errors)
    2. `grep -c "export" sdk/src/index.ts` shows increased export count
    3. `grep "connectWallet" sdk/src/wallet.ts` confirms function exists
    4. `grep "generateCalldata" sdk/src/submitter.ts` confirms function exists
    5. `grep "submitProof" sdk/src/submitter.ts` confirms function exists
    6. `grep "WalletState" sdk/src/types.ts` confirms type exists
    7. `grep "SubmitResult" sdk/src/types.ts` confirms type exists
    8. `grep "VerificationRecord" sdk/src/types.ts` confirms type exists
    9. Vite dev server starts: `cd sdk && npx vite --port 5173` (no build errors)
  </verify>
  <done>
    wallet.ts exports connectWallet/disconnectWallet/getWalletAccount using get-starknet v4 + WalletAccount. submitter.ts exports generateCalldata (garaga WASM calldata generation with inline flattenPublicInputs) and submitProof (wallet.execute with proper Span serialization). types.ts has WalletState, SubmitResult, CalldataResult, VerificationRecord. index.ts re-exports all new modules. TypeScript compiles clean and Vite dev server starts.
  </done>
</task>

</tasks>

<verification>
1. `cd sdk && npm ls starknet @starknet-io/get-starknet` -- both dependencies installed at correct versions
2. `ls sdk/public/vk/` -- age_verify.vk and membership_proof.vk present
3. `cd sdk && npx tsc --noEmit` -- TypeScript compiles without errors
4. `cd sdk && npx vite --port 5173` -- Vite dev server starts without build errors
5. `grep "REGISTRY_ADDRESS" sdk/src/config.ts` -- matches 0x054ca264...
6. All new modules (config.ts, wallet.ts, submitter.ts) exist with correct exports
7. index.ts re-exports all new modules alongside existing Phase 5 exports
</verification>

<success_criteria>
- starknet@8.9.2 and @starknet-io/get-starknet@4 installed in sdk/package.json
- VK binary files bundled as static assets in sdk/public/vk/
- config.ts centralizes all contract addresses, RPC URL, and circuit mappings
- wallet.ts provides wallet connection/disconnection via get-starknet v4 modal
- submitter.ts generates garaga calldata from ProofResult and submits via WalletAccount.execute
- types.ts defines WalletState, SubmitResult, CalldataResult, VerificationRecord
- index.ts barrel-exports all new modules
- TypeScript compiles clean, Vite dev server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-wallet-chain-sdk/06-01-SUMMARY.md`
</output>
