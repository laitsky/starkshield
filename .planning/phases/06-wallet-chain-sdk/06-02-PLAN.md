---
phase: 06-wallet-chain-sdk
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - sdk/src/reader.ts
  - sdk/src/index.ts
  - sdk/index.html
autonomous: true

must_haves:
  truths:
    - "The SDK can query on-chain verification status by nullifier and return whether a verification exists, its attribute key, threshold/set hash, timestamp, and circuit ID"
    - "The E2E test page allows wallet connection, proof generation, calldata generation, on-chain submission, and verification status querying in a single flow"
  artifacts:
    - path: "sdk/src/reader.ts"
      provides: "On-chain verification status querying via RpcProvider"
      exports: ["isNullifierUsed", "getVerificationRecord"]
    - path: "sdk/src/index.ts"
      provides: "Re-exports reader module"
      contains: "from './reader'"
    - path: "sdk/index.html"
      provides: "Updated E2E test page with wallet connect, submit proof, and query status buttons"
      contains: "btn-connect"
  key_links:
    - from: "sdk/src/reader.ts"
      to: "starknet RpcProvider"
      via: "contract.is_nullifier_used() and contract.get_verification_record()"
      pattern: "RpcProvider"
    - from: "sdk/src/reader.ts"
      to: "sdk/src/config.ts"
      via: "REGISTRY_ADDRESS and SEPOLIA_RPC_URL for provider and contract instantiation"
      pattern: "REGISTRY_ADDRESS"
    - from: "sdk/index.html"
      to: "sdk/src/index.ts"
      via: "imports connectWallet, generateCalldata, submitProof, getVerificationRecord"
      pattern: "import.*from.*index"
---

<objective>
Build the on-chain verification status reader module and update the E2E test page to demonstrate the complete wallet-to-chain flow: connect wallet, generate proof, create calldata, submit on-chain, then query verification status.

Purpose: Completes the Phase 6 "read path" -- dApps can query whether a nullifier has been used and retrieve the full verification record. The updated test page validates the entire Phase 6 integration in a browser.

Output: reader.ts module with nullifier querying, updated index.ts exports, and updated index.html with full wallet + submit + query UI.
</objective>

<execution_context>
@/Users/laitsky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laitsky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-wallet-chain-sdk/06-RESEARCH.md
@.planning/phases/06-wallet-chain-sdk/06-01-SUMMARY.md
@sdk/src/types.ts
@sdk/src/index.ts
@sdk/src/config.ts
@sdk/src/submitter.ts
@sdk/src/wallet.ts
@contracts/src/registry.cairo
@deployments.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build on-chain reader module and update E2E test page</name>
  <files>
    sdk/src/reader.ts
    sdk/src/index.ts
    sdk/index.html
  </files>
  <action>
    **Step 1: Create `sdk/src/reader.ts`**

    This module provides read-only on-chain queries using RpcProvider (no wallet needed):

    ```typescript
    import { RpcProvider, Contract } from 'starknet';
    import { REGISTRY_ADDRESS, SEPOLIA_RPC_URL } from './config';
    import type { VerificationRecord } from './types';

    // Minimal ABI for read functions only.
    // Full ABI is in contracts/target/dev/contracts_StarkShieldRegistry.contract_class.json.
    // We inline only the functions we call to avoid bundling the entire ABI.
    const REGISTRY_READ_ABI = [
      {
        type: 'function',
        name: 'is_nullifier_used',
        inputs: [{ name: 'nullifier', type: 'core::integer::u256' }],
        outputs: [{ type: 'core::bool' }],
        state_mutability: 'view',
      },
      {
        type: 'function',
        name: 'get_verification_record',
        inputs: [{ name: 'nullifier', type: 'core::integer::u256' }],
        outputs: [{ type: 'contracts::registry::VerificationRecord' }],
        state_mutability: 'view',
      },
      {
        type: 'struct',
        name: 'contracts::registry::VerificationRecord',
        members: [
          { name: 'nullifier', type: 'core::integer::u256' },
          { name: 'attribute_key', type: 'core::integer::u256' },
          { name: 'threshold_or_set_hash', type: 'core::integer::u256' },
          { name: 'timestamp', type: 'core::integer::u64' },
          { name: 'circuit_id', type: 'core::integer::u8' },
        ],
      },
      {
        type: 'struct',
        name: 'core::integer::u256',
        members: [
          { name: 'low', type: 'core::integer::u128' },
          { name: 'high', type: 'core::integer::u128' },
        ],
      },
    ];

    let cachedContract: Contract | null = null;

    /**
     * Get or create a read-only Contract instance for the registry.
     */
    function getRegistryContract(): Contract {
      if (cachedContract) return cachedContract;
      const provider = new RpcProvider({ nodeUrl: SEPOLIA_RPC_URL });
      cachedContract = new Contract(REGISTRY_READ_ABI, REGISTRY_ADDRESS, provider);
      return cachedContract;
    }

    /**
     * Check if a nullifier has been used on-chain.
     *
     * @param nullifier - The nullifier to check (bigint or hex string)
     * @returns true if the nullifier has been used
     */
    export async function isNullifierUsed(nullifier: bigint | string): Promise<boolean> {
      const contract = getRegistryContract();
      const result = await contract.is_nullifier_used(nullifier);
      return Boolean(result);
    }

    /**
     * Get the full verification record for a nullifier.
     *
     * @param nullifier - The nullifier to query (bigint or hex string)
     * @returns VerificationRecord with exists flag and all fields
     */
    export async function getVerificationRecord(nullifier: bigint | string): Promise<VerificationRecord> {
      const contract = getRegistryContract();

      // First check if nullifier exists
      const exists = await isNullifierUsed(nullifier);
      if (!exists) {
        return {
          exists: false,
          nullifier: 0n,
          attributeKey: 0n,
          thresholdOrSetHash: 0n,
          timestamp: 0,
          circuitId: 0,
        };
      }

      // Get full record
      const record = await contract.get_verification_record(nullifier);

      return {
        exists: true,
        nullifier: BigInt(record.nullifier),
        attributeKey: BigInt(record.attribute_key),
        thresholdOrSetHash: BigInt(record.threshold_or_set_hash),
        timestamp: Number(record.timestamp),
        circuitId: Number(record.circuit_id),
      };
    }
    ```

    **IMPORTANT for reader.ts:** The starknet.js Contract class with ABI handles u256 serialization automatically -- it splits a single bigint into (low: u128, high: u128) internally. Do NOT manually split u256 values. The minimal inlined ABI must include the u256 struct definition for this auto-serialization to work.

    **Step 2: Update `sdk/src/index.ts`**

    Add reader exports after the existing exports (which now include Plan 06-01 additions):

    ```typescript
    // On-chain verification queries
    export { isNullifierUsed, getVerificationRecord } from './reader';
    ```

    **Step 3: Update `sdk/index.html`**

    Add wallet connection, proof submission, and verification query buttons to the existing E2E test page. Keep all existing proof generation buttons and logic. Add new sections:

    1. **Wallet section** (above proof controls): "Connect Wallet" button showing address after connection
    2. **Submit section** (below proof controls): "Submit Age Proof" and "Submit Membership Proof" buttons that generate proof + calldata + submit in one flow. These buttons are disabled until wallet is connected.
    3. **Query section** (below submit): "Query Nullifier" button with an input field for nullifier value. Shows the full VerificationRecord.

    The submit flow should be:
    a. Generate proof (reuse existing proof generation)
    b. Generate calldata (call `generateCalldata`)
    c. Submit to chain (call `submitProof`)
    d. Log transaction hash
    e. Automatically query the verification status using the nullifier from publicInputs

    Import the new functions from `./src/index.ts`:
    ```typescript
    import {
      // Existing
      initWasm, validateAgeCredential, validateMembershipCredential,
      generateAgeProof, generateMembershipProof, verifyProofLocally,
      // New from Plan 06-01
      connectWallet, disconnectWallet, generateCalldata, submitProof,
      // New from this task
      isNullifierUsed, getVerificationRecord,
      // Config
      REGISTRY_ADDRESS,
    } from './src/index.ts';
    ```

    The page layout should have three sections:
    - **Wallet**: Connect/disconnect button + address display
    - **Proofs**: Existing proof generation buttons (keep as-is) + new "Submit on-chain" buttons
    - **Query**: Nullifier input + query button + results display

    Key UI behavior:
    - "Connect Wallet" opens get-starknet modal. After connection, display the wallet address (truncated: 0x0123...abcd) and enable submission buttons.
    - "Submit Age Proof On-Chain" runs: generate proof -> generate calldata -> submit to registry -> wait for tx -> query verification status -> display results
    - "Query Verification" takes a nullifier hex value and calls getVerificationRecord, displaying the full record.
    - All operations log to the same output pre element used by existing proof generation.

    For the nullifier extraction from publicInputs: per Phase 2/3 decisions, the nullifier is at index 5 for age_verify (9 public inputs) and index 12 for membership_proof (16 public inputs). The value is a hex string from ProofResult.publicInputs.
  </action>
  <verify>
    1. TypeScript compiles: `cd sdk && npx tsc --noEmit` (no errors)
    2. `grep "isNullifierUsed" sdk/src/reader.ts` confirms function exists
    3. `grep "getVerificationRecord" sdk/src/reader.ts` confirms function exists
    4. `grep "from './reader'" sdk/src/index.ts` confirms re-export
    5. `grep "btn-connect" sdk/index.html` confirms wallet connect button exists
    6. `grep "submitProof" sdk/index.html` confirms submit integration
    7. `grep "getVerificationRecord" sdk/index.html` confirms query integration
    8. Vite dev server starts: `cd sdk && npx vite --port 5173` (no build errors)
    9. Open http://localhost:5173 -- page loads without console errors (wallet connect + proof buttons visible)
  </verify>
  <done>
    reader.ts exports isNullifierUsed and getVerificationRecord using starknet.js RpcProvider with inlined minimal ABI (includes u256 struct for auto-serialization). index.ts re-exports reader module. index.html updated with wallet connect button, on-chain proof submission buttons, and nullifier query section. Vite dev server starts clean and the page loads without errors.
  </done>
</task>

</tasks>

<verification>
1. `cd sdk && npx tsc --noEmit` -- TypeScript compiles without errors
2. `cd sdk && npx vite --port 5173` -- Vite dev server starts without build errors
3. All SDK modules exist: config.ts, wallet.ts, submitter.ts, reader.ts
4. index.ts exports all modules (wallet, submitter, reader, config)
5. index.html has wallet connect, proof generation, on-chain submission, and verification query sections
6. VK files present in sdk/public/vk/
7. Open http://localhost:5173 -- page loads, "Connect Wallet" button visible, proof generation buttons work as before

Full integration test (requires ArgentX/Braavos wallet extension):
1. Click "Connect Wallet" -- get-starknet modal appears, select wallet, address displayed
2. Click "Submit Age Proof On-Chain" -- proof generates, calldata computed, wallet prompts for signature, transaction submitted, transaction hash logged
3. After submission, nullifier query automatically runs and shows verification record
</verification>

<success_criteria>
- reader.ts queries is_nullifier_used and get_verification_record from the deployed StarkShieldRegistry
- reader.ts uses starknet.js Contract class with minimal inlined ABI for auto u256 serialization
- index.ts re-exports isNullifierUsed and getVerificationRecord
- index.html provides complete E2E flow: wallet connect -> proof generation -> calldata -> submit -> query
- TypeScript compiles clean, Vite dev server starts without errors
- Page loads in browser without console errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-wallet-chain-sdk/06-02-SUMMARY.md`
</output>
