---
phase: 05-proof-engine-sdk
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sdk/package.json
  - sdk/tsconfig.json
  - sdk/vite.config.ts
  - sdk/src/types.ts
  - sdk/src/circuits/age_verify.json
  - sdk/src/circuits/membership_proof.json
  - sdk/public/credentials/demo_credential.json
  - sdk/public/credentials/demo_credential_membership.json
  - sdk/src/init.ts
  - sdk/src/credentials.ts
  - sdk/src/prover.ts
  - sdk/src/index.ts
  - sdk/index.html
autonomous: true

must_haves:
  truths:
    - "The SDK initializes noir_js and bb.js WASM backends in a browser tab"
    - "A demo credential JSON file is loaded, validated, and transformed into circuit-compatible witness inputs"
    - "A valid ZK proof is generated from a demo credential entirely client-side in the browser"
    - "Proof generation completes in under 30 seconds with SharedArrayBuffer enabled"
    - "Both age_verify and membership_proof circuits can generate proofs"
  artifacts:
    - path: "sdk/package.json"
      provides: "SDK dependencies pinned to correct versions"
      contains: "@noir-lang/noir_js.*1.0.0-beta.16"
    - path: "sdk/vite.config.ts"
      provides: "Vite config with COOP/COEP headers, bb.js exclusion, node polyfills"
      contains: "Cross-Origin-Embedder-Policy"
    - path: "sdk/src/init.ts"
      provides: "WASM initialization gate for noir_js ACVM and noirc_abi"
      exports: ["initWasm"]
    - path: "sdk/src/credentials.ts"
      provides: "Credential loading, validation, and witness input transformation"
      exports: ["validateAgeCredential", "validateMembershipCredential", "credentialToAgeInputs", "credentialToMembershipInputs"]
    - path: "sdk/src/prover.ts"
      provides: "Proof generation engine for both circuit types"
      exports: ["generateAgeProof", "generateMembershipProof"]
    - path: "sdk/src/types.ts"
      provides: "TypeScript type definitions for credentials, proof data, circuit types"
      contains: "CredentialJSON"
    - path: "sdk/src/index.ts"
      provides: "Public API barrel export"
      min_lines: 5
    - path: "sdk/index.html"
      provides: "Browser E2E test page for proof generation"
      contains: "generateAgeProof"
  key_links:
    - from: "sdk/src/prover.ts"
      to: "sdk/src/init.ts"
      via: "initWasm() call before any noir_js operation"
      pattern: "initWasm"
    - from: "sdk/src/prover.ts"
      to: "sdk/src/circuits/age_verify.json"
      via: "JSON import of compiled circuit artifact"
      pattern: "import.*age_verify"
    - from: "sdk/src/credentials.ts"
      to: "sdk/src/types.ts"
      via: "CredentialJSON type import"
      pattern: "import.*CredentialJSON"
    - from: "sdk/index.html"
      to: "sdk/src/prover.ts"
      via: "import and call generateAgeProof/generateMembershipProof"
      pattern: "generate.*Proof"
---

<objective>
Build the complete Proof Engine SDK: a TypeScript package that initializes WASM backends (noir_js + bb.js), loads and validates credential JSON files, transforms them into circuit-compatible witness inputs, and generates ZK proofs entirely client-side in the browser. Validate end-to-end with both age_verify and membership_proof circuits using existing demo credentials.

Purpose: This is the core client-side engine that bridges the gap between the user's private credentials and the on-chain verification system. Everything downstream (wallet SDK, web app) depends on this proof generation capability.
Output: Working `sdk/` package with browser proof generation validated via Vite dev server test page.
</objective>

<execution_context>
@/Users/laitsky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laitsky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-proof-engine-sdk/05-RESEARCH.md
@circuits/target/age_verify.json (ABI only -- too large to read fully, use python3 to extract .abi)
@circuits/target/membership_proof.json (ABI only -- same)
@scripts/demo_credential.json
@scripts/demo_credential_membership.json
@deployments.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold SDK package with Vite, dependencies, and circuit artifacts</name>
  <files>
    sdk/package.json
    sdk/tsconfig.json
    sdk/vite.config.ts
    sdk/src/types.ts
    sdk/src/circuits/age_verify.json
    sdk/src/circuits/membership_proof.json
    sdk/public/credentials/demo_credential.json
    sdk/public/credentials/demo_credential_membership.json
  </files>
  <action>
    1. Create `sdk/` directory at project root.

    2. Create `sdk/package.json` with these EXACT pinned dependencies:
       - dependencies: `@noir-lang/noir_js@1.0.0-beta.16`, `@aztec/bb.js@3.0.0-nightly.20251104`, `garaga@1.0.1`
       - devDependencies: `vite@6`, `vite-plugin-node-polyfills@0.17.0`, `typescript@5`
       - Set `"type": "module"` and add scripts: `"dev": "vite"`, `"build": "vite build"`

    3. Run `npm install` in `sdk/`.

    4. Create `sdk/tsconfig.json`:
       - target: ESNext, module: ESNext, moduleResolution: bundler
       - strict: true, resolveJsonModule: true, esModuleInterop: true
       - include: ["src/**/*"], outDir: "dist"

    5. Create `sdk/vite.config.ts` with ALL of these:
       - Import and configure `vite-plugin-node-polyfills` with `globals: { Buffer: true, global: true, process: true }` and `protocolImports: true`
       - Custom middleware plugin named `configure-response-headers` that sets `Cross-Origin-Embedder-Policy: require-corp` and `Cross-Origin-Opener-Policy: same-origin` on every response (required for SharedArrayBuffer)
       - `optimizeDeps: { exclude: ['@aztec/bb.js'] }` -- bb.js WASM loading breaks if Vite pre-bundles it
       - `build: { target: 'esnext' }` -- required for bb.js top-level await
       - `assetsInclude: ['**/*.wasm']` for WASM file handling

    6. Create `sdk/src/types.ts` with TypeScript interfaces:
       - `CredentialJSON`: All 11 fields from demo credential files (subject_id through issuer_pub_key_y -- hex strings + signature number array). Include optional `credential_hash`, `nullifier`, `dapp_context_id` fields for reference data that exists in JSON but is not used as circuit input.
       - `CircuitType`: Union type `'age_verify' | 'membership_proof'`
       - `ProofResult`: `{ proof: Uint8Array; publicInputs: string[]; provingTimeMs: number }`
       - `AgeProofParams`: `{ threshold: number; dappContextId: number; currentTimestamp?: number }`
       - `MembershipProofParams`: `{ allowedSet: string[]; dappContextId: number; currentTimestamp?: number }`
       - `ValidationResult`: `{ valid: boolean; errors: string[] }`

    7. Copy circuit artifacts:
       - `cp circuits/target/age_verify.json sdk/src/circuits/age_verify.json`
       - `cp circuits/target/membership_proof.json sdk/src/circuits/membership_proof.json`

    8. Copy demo credentials to Vite's public directory (so they are served as static assets at `/credentials/` URLs):
       - `mkdir -p sdk/public/credentials`
       - `cp scripts/demo_credential.json sdk/public/credentials/demo_credential.json`
       - `cp scripts/demo_credential_membership.json sdk/public/credentials/demo_credential_membership.json`

    IMPORTANT VERSION NOTE: Do NOT use @aztec/bb.js@0.82.3 (that is in scripts/ for the issuer, different API). The SDK MUST use @aztec/bb.js@3.0.0-nightly.20251104 which matches the bb CLI version used to generate VKs and proofs throughout the project.
  </action>
  <verify>
    - `cat sdk/package.json` shows correct version pins
    - `ls sdk/node_modules/@noir-lang/noir_js sdk/node_modules/@aztec/bb.js` confirms packages installed
    - `ls sdk/src/circuits/age_verify.json sdk/src/circuits/membership_proof.json` confirms circuit artifacts copied
    - `ls sdk/public/credentials/` confirms demo credentials copied to public directory
    - `npx tsc --noEmit -p sdk/tsconfig.json` compiles types.ts without errors (may need to stub other files first)
  </verify>
  <done>
    SDK package scaffolded with correct dependency versions installed, Vite configured with COOP/COEP headers and bb.js exclusion, circuit artifacts and demo credentials in place, TypeScript types defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build core SDK modules -- WASM init, credential loading, and proof generation</name>
  <files>
    sdk/src/init.ts
    sdk/src/credentials.ts
    sdk/src/prover.ts
    sdk/src/index.ts
  </files>
  <action>
    1. Create `sdk/src/init.ts` -- WASM initialization gate:
       - Import `initNoirC` from `@noir-lang/noirc_abi` and `initACVM` from `@noir-lang/acvm_js`
       - Import WASM URLs with Vite `?url` suffix: `import acvm from '@noir-lang/acvm_js/web/acvm_js_bg.wasm?url'` and `import noirc from '@noir-lang/noirc_abi/web/noirc_abi_wasm_bg.wasm?url'`
       - Module-level `initialized` boolean flag
       - Export `async function initWasm(): Promise<void>` that calls `Promise.all([initACVM(fetch(acvm)), initNoirC(fetch(noirc))])` and sets flag
       - Guard: if already initialized, return immediately
       - Add a `declare module` block at the top of the file for the `?url` imports if TypeScript complains, OR create a `sdk/src/vite-env.d.ts` with Vite client types: `/// <reference types="vite/client" />`

    2. Create `sdk/src/credentials.ts` -- credential loading and validation:
       - Import `CredentialJSON`, `ValidationResult`, `AgeProofParams`, `MembershipProofParams` from `./types`
       - Import `InputMap` type from `@noir-lang/noir_js`

       `validateAgeCredential(cred: CredentialJSON): ValidationResult`:
       - Check all 11 required fields exist (subject_id, issuer_id, credential_type, attribute_key, attribute_value, issued_at, expires_at, secret_salt, signature, issuer_pub_key_x, issuer_pub_key_y)
       - Validate signature is array of exactly 64 numbers, each 0-255
       - Validate hex fields start with "0x"
       - Validate credential_type is 0 (age type)
       - Return `{ valid, errors }`

       `validateMembershipCredential(cred: CredentialJSON): ValidationResult`:
       - Same as age but credential_type must be 1 (membership type)

       `credentialToAgeInputs(cred: CredentialJSON, params: AgeProofParams): InputMap`:
       - Map all 8 private credential fields directly (hex strings pass through)
       - CRITICAL: signature must be mapped as `cred.signature.map(b => b.toString())` -- noir_js needs string values, not numbers
       - Map public inputs: `pub_key_x` from `cred.issuer_pub_key_x`, `pub_key_y` from `cred.issuer_pub_key_y`
       - `current_timestamp`: Use `params.currentTimestamp ?? Math.floor(Date.now() / 1000)`, convert to hex: `'0x' + ts.toString(16)`
       - `threshold`: `'0x' + params.threshold.toString(16)`
       - `dapp_context_id`: `'0x' + params.dappContextId.toString(16)`

       `credentialToMembershipInputs(cred: CredentialJSON, params: MembershipProofParams): InputMap`:
       - Same private fields as age
       - Same pub_key_x, pub_key_y, current_timestamp, dapp_context_id
       - NO threshold field (membership circuit does not have it)
       - `allowed_set`: Pad to exactly 8 elements with '0x0', throw if >8 provided. These are Field hex strings.

    3. Create `sdk/src/prover.ts` -- proof generation engine:
       - Import `Noir` from `@noir-lang/noir_js`
       - Import `UltraHonkBackend` from `@aztec/bb.js`
       - Import circuit JSONs: `import ageCircuit from './circuits/age_verify.json'` and `import membershipCircuit from './circuits/membership_proof.json'`
       - Import `initWasm` from `./init`
       - Import types from `./types`
       - Import credential transform functions from `./credentials`

       `async function generateAgeProof(credential: CredentialJSON, params: AgeProofParams): Promise<ProofResult>`:
       - Call `await initWasm()` first (ensures WASM is loaded)
       - Build inputs via `credentialToAgeInputs(credential, params)`
       - Create `new Noir(ageCircuit as any)` and call `const { witness } = await noir.execute(inputs)`
       - Create `new UltraHonkBackend(ageCircuit.bytecode)` and call `const proof = await backend.generateProof(witness, { keccak: true })`
         NOTE: Use `{ keccak: true }` per Phase 4 CLI validation. If on-chain verification fails later (Phase 6), switch to `{ keccakZK: true }` -- one-line change.
       - Call `await backend.destroy()` for cleanup
       - Return `{ proof: proof.proof, publicInputs: proof.publicInputs, provingTimeMs }`
       - Wrap in try/catch, re-throw with descriptive error messages
       - Measure proving time with `performance.now()`

       `async function generateMembershipProof(credential: CredentialJSON, params: MembershipProofParams): Promise<ProofResult>`:
       - Same pattern but uses `membershipCircuit` and `credentialToMembershipInputs`

       `async function verifyProofLocally(circuitType: CircuitType, proofData: ProofResult): Promise<boolean>`:
       - Select circuit JSON based on circuitType
       - Create backend, call `backend.verifyProof({ proof: proofData.proof, publicInputs: proofData.publicInputs }, { keccak: true })`
       - Return boolean result

    4. Create `sdk/src/index.ts` -- barrel export:
       - Re-export all public functions from init, credentials, prover
       - Re-export all types from types

    5. Create `sdk/src/vite-env.d.ts`:
       - `/// <reference types="vite/client" />` for WASM `?url` import type support
  </action>
  <verify>
    - `npx tsc --noEmit -p sdk/tsconfig.json` compiles all modules without errors
    - Check that `sdk/src/init.ts` imports WASM URLs with `?url` suffix
    - Check that `sdk/src/credentials.ts` maps `signature` with `.map(b => b.toString())`
    - Check that `sdk/src/prover.ts` uses `{ keccak: true }` option
    - Check that `sdk/src/prover.ts` calls `initWasm()` before noir_js operations
    - Check that `sdk/src/prover.ts` calls `backend.destroy()` after proof generation
  </verify>
  <done>
    All four core SDK modules compile without errors. init.ts gates WASM loading, credentials.ts validates and transforms both credential types, prover.ts generates proofs for both circuit types with timing measurement, index.ts exports the public API.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create browser E2E test page and validate proof generation for both circuits</name>
  <files>
    sdk/index.html
  </files>
  <action>
    1. Create `sdk/index.html` -- a minimal browser test page that:
       - Has a `<script type="module">` block importing from `./src/index.ts`
       - Displays a "StarkShield Proof Engine SDK - E2E Test" heading
       - Has two buttons: "Generate Age Proof" and "Generate Membership Proof"
       - Has a status `<pre>` element for output logging
       - On "Generate Age Proof" click:
         a. Log "Loading age credential..."
         b. Fetch `/credentials/demo_credential.json` and parse
         c. Log "Validating credential..."
         d. Call `validateAgeCredential()` and display result
         e. Log "Generating proof (this may take 10-30 seconds)..."
         f. Call `generateAgeProof(credential, { threshold: 18, dappContextId: 42 })` -- threshold 18 (age >= 18), dappContextId 42 (matching demo credential)
         g. Log proof result: public inputs count, proof byte length, proving time in ms
         h. Log "Verifying proof locally..."
         i. Call `verifyProofLocally('age_verify', proofResult)` and log result
       - On "Generate Membership Proof" click:
         a. Same pattern but fetch `/credentials/demo_credential_membership.json`
         b. Call `validateMembershipCredential()`
         c. Call `generateMembershipProof(credential, { allowedSet: ['0x64', '0x65', '0x66'], dappContextId: 42 })`
            NOTE: 0x64 = 100 decimal, which is the attribute_value in the demo membership credential. The allowed_set must contain this value for the proof to succeed.
         d. Verify locally
       - Style with minimal inline CSS for readability

    2. Start the Vite dev server:
       - Run `cd sdk && npx vite --port 5173` (in background)
       - Confirm it starts and shows COOP/COEP headers

    3. CRITICAL VALIDATION: Open the test page in a browser-like environment and verify:
       - Since we cannot open a real browser from CLI, validate by:
         a. Confirming `npx vite` starts without errors
         b. Checking that the dev server responds with COOP/COEP headers: `curl -sI http://localhost:5173/ | grep -i cross-origin`
         c. Confirming index.html is served correctly: `curl -s http://localhost:5173/ | head -20`
         d. Confirming circuit JSON is accessible: `curl -s http://localhost:5173/credentials/demo_credential.json | head -5`

    4. If TypeScript compilation fails due to version mismatches (noir_js beta.16 + bb.js 3.0.0-nightly), document the error and attempt these fallbacks in order:
       a. Add type assertions (`as any`) where needed
       b. If noir_js beta.16 witness format is incompatible with bb.js, try `@noir-lang/noir_js@1.0.0-beta.15`
       c. Document any version changes in the SUMMARY
  </action>
  <verify>
    - `curl -sI http://localhost:5173/ | grep -i "cross-origin"` shows both COOP and COEP headers
    - `curl -s http://localhost:5173/ | grep "StarkShield"` confirms test page is served
    - `curl -s http://localhost:5173/credentials/demo_credential.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(d['subject_id'][:20])"` confirms credential JSON is accessible
    - `npx tsc --noEmit -p sdk/tsconfig.json` passes (all TypeScript compiles)
    - Vite dev server starts without errors
  </verify>
  <done>
    Browser E2E test page is created and served via Vite dev server with COOP/COEP headers. The page imports SDK modules, provides buttons to generate proofs for both circuit types, and displays results. Vite dev server starts without errors, serves COOP/COEP headers, and static credential files are accessible. TypeScript compilation passes for all SDK modules. The user can open http://localhost:5173 in Chrome to complete the browser proof generation validation.
  </done>
</task>

</tasks>

<verification>
Phase 5 verification checklist:

1. **SDK scaffold:** `sdk/` directory exists with package.json, node_modules, vite.config.ts, tsconfig.json
2. **Correct versions:** `cat sdk/package.json | grep -E "noir_js|bb.js"` shows beta.16 and 3.0.0-nightly.20251104
3. **Core modules:** `ls sdk/src/init.ts sdk/src/credentials.ts sdk/src/prover.ts sdk/src/types.ts sdk/src/index.ts` -- all exist
4. **Circuit artifacts:** `ls sdk/src/circuits/age_verify.json sdk/src/circuits/membership_proof.json` -- both copied
5. **TypeScript:** `npx tsc --noEmit -p sdk/tsconfig.json` passes
6. **COOP/COEP:** `curl -sI http://localhost:5173/ | grep -i cross-origin` shows both headers
7. **Credential serving:** `curl -s http://localhost:5173/credentials/demo_credential.json` returns valid JSON
8. **Browser test:** User opens http://localhost:5173 in Chrome, clicks "Generate Age Proof", sees proof generated with timing < 30s

The browser proof generation (item 8) is the ultimate validation -- it exercises the entire pipeline: WASM init, credential loading, witness computation, and proof generation. The user verifies this manually after the plan executes.
</verification>

<success_criteria>
- TypeScript SDK compiles without errors
- Vite dev server starts and serves COOP/COEP headers
- Demo credential JSON files accessible via Vite static serving
- Browser test page loads and imports SDK modules
- User can click "Generate Age Proof" in Chrome and see a valid proof generated in < 30 seconds
- User can click "Generate Membership Proof" and see a valid proof generated
- `verifyProofLocally()` returns true for both generated proofs
</success_criteria>

<output>
After completion, create `.planning/phases/05-proof-engine-sdk/05-01-SUMMARY.md`
</output>
